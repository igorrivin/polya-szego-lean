/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 21c5a0ed-178b-49d8-9013-f2a2e56bdbcd
-/

/-
I have formalized and proven Polya-Szego Problem 130.

The formalization required some adjustments to the user's code:
1.  **Imports and Namespaces**: Added `open MeasureTheory Filter Topology Set` and ensured necessary imports were present (though imports are handled by the environment, the `open` commands were crucial for `IntegrableOn`, `Tendsto`, etc.).
2.  **Notation**: Replaced the user's `‚à´ t in (0:‚Ñù)..‚àû` with `‚à´ t in Set.Ioi 0` and `ùìù[>] 0` with `nhdsWithin 0 (Set.Ioi 0)` to avoid notation errors and ensure compatibility with Mathlib.
3.  **Statement**: The theorem `problem_130` states that if $f$ is measurable, the integral $\int_0^\infty e^{-\epsilon t} f(t) dt$ exists for all $\epsilon > 0$, and $\lim_{t \to \infty} f(t) = L$ exists, then $\lim_{\epsilon \to 0^+} \epsilon \int_0^\infty e^{-\epsilon t} f(t) dt = L$.

The ATP successfully proved both the existential version `problem_130` and the explicit version `problem_130_explicit`. The proof relies on splitting the integral and using the limit definition, effectively an Abelian theorem for Laplace transforms.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

open MeasureTheory Filter Topology Set

theorem problem_130 {f : ‚Ñù ‚Üí ‚Ñù} (hf : Measurable f) (hint : ‚àÄ Œµ > 0, IntegrableOn (fun t ‚Ü¶ Real.exp (-Œµ * t) * f t) (Set.Ici 0))
    (hlim : ‚àÉ L : ‚Ñù, Tendsto f atTop (ùìù L)) :
    ‚àÉ L : ‚Ñù,
      Tendsto f atTop (ùìù L) ‚àß
      Tendsto (fun (Œµ : ‚Ñù) ‚Ü¶ Œµ * ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * f t)
        (nhdsWithin 0 (Set.Ioi 0)) (ùìù L) := by
  -- Now use the fact that the integral of $e^{-\varepsilon t} (f(t) - L)$ tends to 0 as $\varepsilon \to 0^+$.
  have h_integral : Filter.Tendsto (fun Œµ => Œµ * ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose)) (ùìù[>] 0) (ùìù 0) := by
    -- Given that $f$ tends to $L$, for any $\delta > 0$, there exists $T$ such that for $t > T$, $|f(t) - L| < \delta$.
    have h_bound : ‚àÄ Œ¥ > 0, ‚àÉ T > 0, ‚àÄ Œµ > 0, ‚à´ t in Set.Ioi 0, |Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ (‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) + Œ¥ / Œµ := by
      intros Œ¥ hŒ¥_pos
      obtain ‚ü®T, hT‚ü© : ‚àÉ T > 0, ‚àÄ t ‚â• T, |f t - hlim.choose| < Œ¥ := by
        rcases Metric.tendsto_atTop.mp hlim.choose_spec Œ¥ hŒ¥_pos with ‚ü® T, hT ‚ü© ; exact ‚ü® Max.max T 1, by positivity, fun t ht => hT t <| le_trans ( le_max_left _ _ ) ht ‚ü©;
      -- Split the integral into two parts: from 0 to T and from T to infinity.
      have h_split : ‚àÄ Œµ > 0, ‚à´ t in Set.Ioi 0, |Real.exp (-Œµ * t) * (f t - hlim.choose)| = (‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) + (‚à´ t in Set.Ioi T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) := by
        intro Œµ hŒµ_pos
        have h_split : ‚à´ t in Set.Ioi 0, |Real.exp (-Œµ * t) * (f t - hlim.choose)| = (‚à´ t in (Set.Ioc 0 T ‚à™ Set.Ioi T), |Real.exp (-Œµ * t) * (f t - hlim.choose)|) := by
          rw [ Set.Ioc_union_Ioi_eq_Ioi ( by linarith ) ];
        rw [ h_split, MeasureTheory.setIntegral_union ] <;> norm_num [ hT.1.le ];
        ¬∑ have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t) * (f t - hlim.choose)) (Set.Ioc 0 T) := by
            have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t) * f t) (Set.Ioc 0 T) := by
              exact MeasureTheory.IntegrableOn.mono_set ( ‚Äπ‚àÄ Œµ > 0, MeasureTheory.IntegrableOn ( fun t => Real.exp ( -Œµ * t ) * f t ) ( Set.Ici 0 ) MeasureTheory.MeasureSpace.volume‚Ä∫ Œµ hŒµ_pos ) ( Set.Ioc_subset_Icc_self.trans ( Set.Icc_subset_Ici_self ) );
            simp_all +decide [ mul_sub ];
            exact MeasureTheory.Integrable.sub h_integrable ( Continuous.integrableOn_Ioc ( by continuity ) );
          simpa [ abs_mul, abs_of_nonneg ( Real.exp_pos _ |> LT.lt.le ) ] using h_integrable.norm;
        ¬∑ have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t) * (f t - hlim.choose)) (Set.Ioi T) := by
            have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t) * f t) (Set.Ioi T) := by
              exact MeasureTheory.IntegrableOn.mono_set ( ‚Äπ‚àÄ Œµ > 0, MeasureTheory.IntegrableOn ( fun t => Real.exp ( -Œµ * t ) * f t ) ( Set.Ici 0 ) MeasureTheory.MeasureSpace.volume‚Ä∫ Œµ hŒµ_pos ) ( Set.Ioi_subset_Ici_self.trans ( Set.Ici_subset_Ici.2 hT.1.le ) );
            simp_all +decide [ mul_sub ];
            refine' h_integrable.sub _;
            have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t)) (Set.Ioi T) := by
              have := ( exp_neg_integrableOn_Ioi 0 hŒµ_pos );
              exact this.mono_set <| Set.Ioi_subset_Ioi hT.1.le;
            simpa only [ neg_mul ] using h_integrable.mul_const _;
          refine' h_integrable.norm.congr _;
          filter_upwards [ MeasureTheory.ae_restrict_mem measurableSet_Ioi ] with t ht using by simp +decide [ abs_mul, Real.exp_pos ] ;
      -- For the second integral, we have $\int_T^\infty e^{-\varepsilon t} |f(t) - L| \, dt \leq \delta \int_T^\infty e^{-\varepsilon t} \, dt$.
      have h_second_integral : ‚àÄ Œµ > 0, ‚à´ t in Set.Ioi T, |Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ Œ¥ * ‚à´ t in Set.Ioi T, Real.exp (-Œµ * t) := by
        intro Œµ hŒµ_pos; rw [ ‚Üê MeasureTheory.integral_const_mul ] ; refine' MeasureTheory.integral_mono_of_nonneg _ _ _;
        ¬∑ exact Filter.Eventually.of_forall fun t => abs_nonneg _;
        ¬∑ have := ( exp_neg_integrableOn_Ioi 0 hŒµ_pos );
          exact MeasureTheory.Integrable.const_mul ( this.mono_set <| Set.Ioi_subset_Ioi hT.1.le ) _;
        ¬∑ filter_upwards [ MeasureTheory.ae_restrict_mem measurableSet_Ioi ] with t ht using by rw [ abs_le ] ; constructor <;> nlinarith [ abs_lt.mp ( hT.2 t ht.out.le ), Real.exp_pos ( -Œµ * t ) ] ;
      -- Evaluate the integral $\int_T^\infty e^{-\varepsilon t} \, dt$.
      have h_integral_eval : ‚àÄ Œµ > 0, ‚à´ t in Set.Ioi T, Real.exp (-Œµ * t) = (1 / Œµ) * Real.exp (-Œµ * T) := by
        intro Œµ hŒµ_pos; have := integral_exp_neg_mul_rpow zero_lt_one hŒµ_pos; norm_num [ Real.rpow_neg_one ] at this ‚ä¢;
        rw [ ‚Üê this, ‚Üê MeasureTheory.integral_mul_const ];
        rw [ ‚Üê MeasureTheory.integral_indicator ( measurableSet_Ioi ), ‚Üê MeasureTheory.integral_indicator ( measurableSet_Ioi ) ];
        simp +decide [ Set.indicator ];
        rw [ ‚Üê MeasureTheory.integral_add_right_eq_self _ T ] ; congr ; ext x ; split_ifs <;> simp_all +decide [ ‚Üê Real.exp_add ] ; linarith;
      exact ‚ü® T, hT.1, fun Œµ Œµ_pos => by rw [ h_split Œµ Œµ_pos ] ; exact add_le_add_left ( le_trans ( h_second_integral Œµ Œµ_pos ) ( by rw [ h_integral_eval Œµ Œµ_pos ] ; ring_nf ; exact mul_le_of_le_one_right ( by positivity ) ( Real.exp_le_one_iff.mpr <| by nlinarith ) ) ) _ ‚ü©;
    -- Using the bound, we can show that the integral of $e^{-\varepsilon t} (f(t) - L)$ tends to 0 as $\varepsilon \to 0^+$.
    have h_integral_zero : ‚àÄ Œ¥ > 0, ‚àÉ T > 0, ‚àÄ Œµ > 0, Œµ * |‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ Œµ * (‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) + Œ¥ := by
      intros Œ¥ hŒ¥_pos
      obtain ‚ü®T, hT_pos, hT‚ü© := h_bound Œ¥ hŒ¥_pos
      use T, hT_pos
      intro Œµ hŒµ_pos
      have h_integral_bound : |‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ (‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) + Œ¥ / Œµ := by
        refine' le_trans ( MeasureTheory.norm_integral_le_integral_norm ( _ : ‚Ñù ‚Üí ‚Ñù ) ) ( hT Œµ hŒµ_pos );
      nlinarith [ mul_div_cancel‚ÇÄ Œ¥ hŒµ_pos.ne' ];
    -- Using the bound, we can show that the integral of $e^{-\varepsilon t} (f(t) - L)$ tends to 0 as $\varepsilon \to 0^+$ by the squeeze theorem.
    have h_integral_zero : ‚àÄ Œ¥ > 0, ‚àÉ Œµ‚ÇÄ > 0, ‚àÄ Œµ ‚àà Set.Ioo 0 Œµ‚ÇÄ, Œµ * |‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ 2 * Œ¥ := by
      intros Œ¥ hŒ¥_pos
      obtain ‚ü®T, hT_pos, hT‚ü© := h_integral_zero Œ¥ hŒ¥_pos
      have h_integral_bound : Filter.Tendsto (fun Œµ => Œµ * ‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)|) (ùìù[>] 0) (ùìù 0) := by
        -- The integral $\int_0^T |e^{-\varepsilon t} (f(t) - L)| dt$ is bounded by $\int_0^T |f(t) - L| dt$ since $|e^{-\varepsilon t}| \leq 1$ for all $t$.
        have h_integral_bound : ‚àÄ Œµ > 0, ‚à´ t in Set.Ioc 0 T, |Real.exp (-Œµ * t) * (f t - hlim.choose)| ‚â§ ‚à´ t in Set.Ioc 0 T, |f t - hlim.choose| := by
          intro Œµ hŒµ_pos; refine' MeasureTheory.integral_mono_of_nonneg _ _ _;
          ¬∑ exact Filter.Eventually.of_forall fun x => abs_nonneg _;
          ¬∑ have h_integrable : MeasureTheory.IntegrableOn (fun t => f t) (Set.Ioc 0 T) := by
              have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (-Œµ * t) * f t) (Set.Ioc 0 T) := by
                exact MeasureTheory.IntegrableOn.mono_set ( ‚Äπ‚àÄ Œµ > 0, MeasureTheory.IntegrableOn ( fun t => Real.exp ( -Œµ * t ) * f t ) ( Set.Ici 0 ) MeasureTheory.MeasureSpace.volume‚Ä∫ Œµ hŒµ_pos ) ( Set.Ioc_subset_Icc_self.trans ( Set.Icc_subset_Ici_self ) );
              have h_integrable : MeasureTheory.IntegrableOn (fun t => Real.exp (Œµ * t) * (Real.exp (-Œµ * t) * f t)) (Set.Ioc 0 T) := by
                refine' MeasureTheory.Integrable.mono' _ _ _;
                use fun t => Real.exp ( Œµ * T ) * |Real.exp ( -Œµ * t ) * f t|;
                ¬∑ exact MeasureTheory.Integrable.const_mul ( h_integrable.norm ) _;
                ¬∑ fun_prop;
                ¬∑ filter_upwards [ MeasureTheory.ae_restrict_mem measurableSet_Ioc ] with t ht using by rw [ Real.norm_eq_abs, abs_mul, abs_of_nonneg ( Real.exp_pos _ |> LT.lt.le ) ] ; exact mul_le_mul_of_nonneg_right ( Real.exp_le_exp.mpr ( mul_le_mul_of_nonneg_left ht.2 hŒµ_pos.le ) ) ( abs_nonneg _ ) ;
              simp_all +decide [ ‚Üê mul_assoc, ‚Üê Real.exp_add ];
            exact MeasureTheory.Integrable.abs ( h_integrable.sub ( MeasureTheory.integrable_const _ ) );
          ¬∑ filter_upwards [ MeasureTheory.ae_restrict_mem measurableSet_Ioc ] with t ht using by rw [ abs_mul, abs_of_nonneg ( Real.exp_pos _ |> le_of_lt ) ] ; exact mul_le_of_le_one_left ( abs_nonneg _ ) ( Real.exp_le_one_iff.mpr <| by nlinarith [ ht.1, ht.2 ] ) ;
        refine' squeeze_zero_norm' _ _;
        use fun Œµ => Œµ * ‚à´ t in Set.Ioc 0 T, |f t - hlim.choose|;
        ¬∑ filter_upwards [ self_mem_nhdsWithin ] with Œµ hŒµ using by rw [ Real.norm_of_nonneg ( mul_nonneg hŒµ.out.le ( MeasureTheory.integral_nonneg fun _ => abs_nonneg _ ) ) ] ; exact mul_le_mul_of_nonneg_left ( h_integral_bound Œµ hŒµ.out ) hŒµ.out.le;
        ¬∑ exact tendsto_nhdsWithin_of_tendsto_nhds ( Continuous.tendsto' ( by continuity ) _ _ ( by norm_num ) );
      have := Metric.tendsto_nhdsWithin_nhds.mp h_integral_bound Œ¥ hŒ¥_pos;
      exact ‚ü® this.choose, this.choose_spec.1, fun Œµ hŒµ => by linarith [ abs_lt.mp ( this.choose_spec.2 hŒµ.1 ( by simpa [ abs_of_pos hŒµ.1 ] using hŒµ.2 ) ), hT Œµ hŒµ.1 ] ‚ü©;
    rw [ Metric.tendsto_nhdsWithin_nhds ];
    simp +zetaDelta at *;
    exact fun Œµ hŒµ => by obtain ‚ü® Œ¥, hŒ¥‚ÇÅ, hŒ¥‚ÇÇ ‚ü© := h_integral_zero ( Œµ / 4 ) ( by positivity ) ; exact ‚ü® Œ¥, hŒ¥‚ÇÅ, fun x hx‚ÇÅ hx‚ÇÇ => by nlinarith [ hŒ¥‚ÇÇ x hx‚ÇÅ ( by linarith [ abs_lt.mp hx‚ÇÇ ] ), abs_of_pos hx‚ÇÅ ] ‚ü© ;
  -- Using the fact that the integral of $e^{-\varepsilon t}$ over $(0, \infty)$ is $\varepsilon^{-1}$, we can simplify the expression.
  have h_simplify : ‚àÄ Œµ > 0, Œµ * ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose) = Œµ * (‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * f t) - hlim.choose := by
    intro Œµ hŒµ_pos
    have h_integral_split : ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * (f t - hlim.choose) = (‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * f t) - (‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * hlim.choose) := by
      rw [ ‚Üê MeasureTheory.integral_sub ] ; congr ; ext ; ring;
      ¬∑ exact MeasureTheory.IntegrableOn.mono_set ( ‚Äπ‚àÄ Œµ > 0, MeasureTheory.IntegrableOn ( fun t => Real.exp ( -Œµ * t ) * f t ) ( Set.Ici 0 ) MeasureTheory.MeasureSpace.volume‚Ä∫ Œµ hŒµ_pos ) ( Set.Ioi_subset_Ici_self );
      ¬∑ exact MeasureTheory.Integrable.mul_const ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact ( by exact by simpa [ mul_comm ] using ( exp_neg_integrableOn_Ioi 0 hŒµ_pos ) ) ) ) ) ) ) ) ) ) ) ) ) _;
    -- The integral of $e^{-\varepsilon t}$ over $(0, \infty)$ is $\varepsilon^{-1}$.
    have h_exp_integral : ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) = 1 / Œµ := by
      convert integral_exp_neg_mul_rpow zero_lt_one hŒµ_pos using 1 <;> norm_num [ Real.rpow_neg_one ];
    simp_all +decide [ MeasureTheory.integral_mul_const ];
    simp +decide [ mul_sub, mul_assoc, mul_left_comm, hŒµ_pos.ne' ];
  exact ‚ü® _, hlim.choose_spec, by simpa using h_integral.add_const hlim.choose |> Filter.Tendsto.congr' ( Filter.eventuallyEq_of_mem self_mem_nhdsWithin fun x hx => by rw [ h_simplify x hx ] ; ring ) ‚ü©

theorem problem_130_explicit {f : ‚Ñù ‚Üí ‚Ñù} (hf : Measurable f)
    (hint : ‚àÄ Œµ > 0, IntegrableOn (fun t ‚Ü¶ Real.exp (-Œµ * t) * f t) (Set.Ici 0))
    (L : ‚Ñù) (hlim : Tendsto f atTop (ùìù L)) :
    Tendsto (fun (Œµ : ‚Ñù) ‚Ü¶ Œµ * ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * f t)
      (nhdsWithin 0 (Set.Ioi 0)) (ùìù L) := by
  -- By the properties of the Laplace transform and the given hypothesis, we can apply the result that the Laplace transform of a function that tends to a limit also tends to that limit.
  have h_laplace : Filter.Tendsto (fun Œµ => Œµ * ‚à´ t in Set.Ioi 0, Real.exp (-Œµ * t) * f t) (ùìù[>] 0) (ùìù L) := by
    have := problem_130 hf (fun Œµ hŒµ => by
      grind) (by
    use L)
    -- Since both $L$ and $L'$ are limits of $f(t)$ as $t$ approaches infinity, they must be equal.
    have h_eq : L = this.choose := by
      exact tendsto_nhds_unique hlim this.choose_spec.1
    (generalize_proofs at *; (
    exact h_eq ‚ñ∏ this.choose_spec.2))
  generalize_proofs at *;
  -- Apply the hypothesis `h_laplace` directly to conclude the proof.
  exact h_laplace