/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 3898590c-8d5a-40a1-a249-72698f98d579
-/

/-
We formalized and proved Polya-Szego Problem 125.
The problem states that if a real function f has a continuous derivative on an interval I, then the set of critical values M = {f(x) | x ∈ I, f'(x) = 0} cannot fill out an entire interval.
We formalized this as: ¬∃ (a b : ℝ), a < b ∧ Set.Ioo a b ⊆ {y | ∃ x ∈ I, f x = y ∧ deriv f x = 0}.
The proof relies on Sard's Theorem, specifically the version `MeasureTheory.addHaar_image_eq_zero_of_det_fderivWithin_eq_zero`.
We proved that the image of the set of critical points has Lebesgue measure zero.
Since any non-trivial open interval has positive Lebesgue measure, it cannot be contained in the set of critical values.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
The determinant of the Fréchet derivative is equal to the scalar derivative.
-/
lemma det_fderivWithin_eq_derivWithin {f : ℝ → ℝ} {I : Set ℝ} {x : ℝ}
    (hI : UniqueDiffWithinAt ℝ I x) (hfd : DifferentiableWithinAt ℝ f I x) :
    (fderivWithin ℝ f I x).det = derivWithin f I x := by
  -- The determinant of the identity operator is 1.
  simp [ContinuousLinearMap.det];
  rfl

/-
The image of the boundary of a convex set (intersected with the set) has measure zero.
-/
lemma measure_image_frontier_inter_zero (I : Set ℝ) (f : ℝ → ℝ) (hI : Convex ℝ I) :
    MeasureTheory.volume (f '' (frontier I ∩ I)) = 0 := by
  have h_finite : frontier I ∩ I ⊆ {InfSet.sInf I, SupSet.sSup I} := by
    intro x hx; by_cases hx_left : x = InfSet.sInf I <;> by_cases hx_right : x = SupSet.sSup I <;> simp_all +decide [ mem_closure_iff_frequently, nhdsWithin ] ;
    -- Since $x$ is not the infimum or supremum of $I$, there exist $y, z \in I$ such that $y < x < z$.
    obtain ⟨y, hyI, hyx⟩ : ∃ y ∈ I, y < x := by
      contrapose! hx_left;
      exact le_antisymm ( le_csInf ⟨ x, hx.2 ⟩ hx_left ) ( csInf_le ⟨ x, hx_left ⟩ hx.2 )
    obtain ⟨z, hzI, hxz⟩ : ∃ z ∈ I, x < z := by
      contrapose! hx_right;
      exact le_antisymm ( le_csSup ⟨ x, hx_right ⟩ hx.2 ) ( csSup_le ⟨ y, hyI ⟩ hx_right ) ▸ rfl;
    exact hx.1.2 ( mem_interior_iff_mem_nhds.mpr <| Filter.mem_of_superset ( Ioo_mem_nhds hyx hxz ) fun u hu => hI.ordConnected.out hyI hzI ⟨ hu.1.le, hu.2.le ⟩ );
  have h_finite_image : f '' (frontier I ∩ I) ⊆ {f (InfSet.sInf I), f (SupSet.sSup I)} := by
    exact Set.image_subset_iff.mpr fun x hx => by specialize h_finite hx; aesop;
  exact MeasureTheory.measure_mono_null h_finite_image ( MeasureTheory.measure_union_null ( MeasureTheory.measure_singleton _ ) ( MeasureTheory.measure_singleton _ ) )

/-
The image of the set of critical points has measure zero.
-/
theorem measure_image_critical_zero (I : Set ℝ) (f : ℝ → ℝ) (hI : Convex ℝ I)
    (hfd : DifferentiableOn ℝ f I) :
    MeasureTheory.volume (f '' {x ∈ I | deriv f x = 0}) = 0 := by
  have h_image_frontier : MeasureTheory.volume (f '' ({x ∈ I | deriv f x = 0} ∩ frontier I)) = 0 := by
    have h_image_frontier : MeasureTheory.volume (f '' (frontier I ∩ I)) = 0 := by
      exact?;
    exact MeasureTheory.measure_mono_null ( Set.image_subset f <| by aesop_cat ) h_image_frontier;
  have h_image_interior : MeasureTheory.volume (f '' ({x ∈ I | deriv f x = 0} ∩ interior I)) = 0 := by
    convert MeasureTheory.addHaar_image_eq_zero_of_det_fderivWithin_eq_zero _ _ _ using 1;
    all_goals try infer_instance;
    exact fun x => fderiv ℝ f x;
    · intro x hx; exact DifferentiableAt.hasFDerivAt ( hfd.differentiableAt ( Filter.mem_of_superset ( mem_interior_iff_mem_nhds.mp hx.2 ) ( by aesop ) ) ) |> HasFDerivAt.hasFDerivWithinAt;
    · aesop;
  convert MeasureTheory.measure_union_null h_image_frontier h_image_interior using 1;
  rw [ ← Set.image_union, ← Set.inter_union_distrib_left ];
  rw [ show { x | x ∈ I ∧ deriv f x = 0 } ∩ ( frontier I ∪ interior I ) = { x | x ∈ I ∧ deriv f x = 0 } from ?_ ];
  ext x; simp [frontier, interior];
  exact fun hx hx' => Or.inl <| subset_closure hx

/-
The set of critical values cannot contain a non-trivial open interval.
-/
theorem problem_125 (I : Set ℝ) (f : ℝ → ℝ) (hI : Convex ℝ I)
    (hfd : DifferentiableOn ℝ f I) (hcont : ContinuousOn (deriv f) I) :
    ¬∃ (a b : ℝ), a < b ∧ Set.Ioo a b ⊆ {y | ∃ x ∈ I, f x = y ∧ deriv f x = 0} := by
      -- By `measure_image_critical_zero`, the Lebesgue measure of $M$ is 0.
      have h_measure_zero : MeasureTheory.volume {y | ∃ x ∈ I, f x = y ∧ deriv f x = 0} = 0 := by
        -- Apply the measure_image_critical_zero theorem to the set {x ∈ I | deriv f x = 0}.
        have h_image_measure_zero : MeasureTheory.volume (f '' {x ∈ I | deriv f x = 0}) = 0 := by
          convert measure_image_critical_zero I f hI hfd using 1;
        convert h_image_measure_zero using 2 ; aesop;
      exact fun ⟨ a, b, hab, h ⟩ => absurd ( h_measure_zero ▸ MeasureTheory.measure_mono h ) ( by simp +decide [ hab ] )