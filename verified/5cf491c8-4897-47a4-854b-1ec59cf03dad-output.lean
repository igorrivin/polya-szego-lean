/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 5cf491c8-4897-47a4-854b-1ec59cf03dad
-/

/-
We have formalized and proved a corrected version of Polya-Szego Problem 172. The original proposed formalization was missing a crucial hypothesis linking the values of the function inside the disk to its values on the boundary. Specifically, for the integral of the boundary values to equal the integral of the radial limits (which by Cauchy's formula is determined by the value at the origin), we need the radial limits to converge to the boundary values almost everywhere.

The corrected theorem `problem_172_corrected` includes the hypothesis `hf_radial`, which states that the radial limits converge to the boundary values at all points of continuity of the boundary function. Since the set of discontinuities is finite, this ensures convergence almost everywhere, allowing the use of the Dominated Convergence Theorem.

The proof proceeds by:
1. Using Cauchy's integral formula to show that for any $r < 1$, $\int_0^{2\pi} f(re^{i\theta}) d\theta = 2\pi f(0)$.
2. Applying the Dominated Convergence Theorem to take the limit as $r \to 1^-$. The sequence of functions $f(re^{i\theta})$ is dominated by the constant $M$ (from the boundedness hypothesis), and converges pointwise almost everywhere to $f(e^{i\theta})$ by the radial limit hypothesis.
3. Concluding that $\int_0^{2\pi} f(e^{i\theta}) d\theta = \lim_{r \to 1^-} \int_0^{2\pi} f(re^{i\theta}) d\theta = 2\pi f(0)$.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Corrected version of Problem 172: If f is analytic and bounded on the open unit disk, and its radial limits match its boundary values almost everywhere (specifically, wherever the boundary function is continuous), then the integral of f over the boundary circle is 2π f(0). The original statement was missing the connection between interior and boundary values.
-/
theorem problem_172_corrected {f : ℂ → ℂ}
    (hf_analytic : DifferentiableOn ℂ f (Metric.ball 0 1))
    (hf_bounded : ∃ M : ℝ, ∀ z ∈ Metric.ball 0 1, ‖f z‖ ≤ M)
    (hf_discontinuities : Set.Finite {θ : ℝ | ¬ContinuousAt (fun θ' : ℝ => f (Real.cos θ' + Real.sin θ' * Complex.I)) θ})
    (hf_radial : ∀ θ, ContinuousAt (fun θ' => f (Real.cos θ' + Real.sin θ' * Complex.I)) θ →
      Filter.Tendsto (fun r : ℝ => f (r * (Real.cos θ + Real.sin θ * Complex.I))) (nhdsWithin 1 (Set.Iio 1)) (nhds (f (Real.cos θ + Real.sin θ * Complex.I)))) :
    (∫ θ in (0 : ℝ)..2 * Real.pi, f (Real.cos θ + Real.sin θ * Complex.I)) = 2 * Real.pi * f 0 := by
  -- For any r in (0, 1), define g_r(θ) = f(r * e^{iθ}). Since f is analytic on B(0, 1), g_r is continuous and the Cauchy integral formula applies to f on the circle of radius r, giving ∫_0^{2π} f(r e^{iθ}) dθ = 2π f(0).
  have h_cont_integral (r : ℝ) (hr : 0 < r ∧ r < 1) : ∫ θ in (0 : ℝ)..2 * Real.pi, f (r * (Real.cos θ + Real.sin θ * Complex.I)) = 2 * Real.pi * f 0 := by
    -- By the properties of the Cauchy integral formula, we have that $\int_{0}^{2\pi} f(re^{i\theta}) d\theta = 2\pi f(0)$ for any $r \in (0, 1)$.
    have h_cauchy : ∀ r : ℝ, 0 < r ∧ r < 1 → ∫ θ in (0 : ℝ)..2 * Real.pi, f (r * Complex.exp (θ * Complex.I)) = 2 * Real.pi * f 0 := by
      intro r hr
      have h_cauchy : ∫ θ in (0 : ℝ)..2 * Real.pi, f (r * Complex.exp (θ * Complex.I)) = (1 / Complex.I) * ∮ (z : ℂ) in C(0, r), f z / z := by
        rw [ circleIntegral ] ; norm_num [ div_eq_inv_mul, mul_assoc, mul_comm, mul_left_comm, hr.1.ne', hr.2.ne' ] ; ring; (
        norm_num [ mul_comm Complex.I, circleMap ]);
      -- By the Cauchy integral formula, we have that $\oint_{|z|=r} \frac{f(z)}{z} \, dz = 2\pi i f(0)$.
      have h_cauchy_integral : (∮ z in C(0, r), f z / z) = 2 * Real.pi * Complex.I * f 0 := by
        have := @Complex.circleIntegral_sub_inv_smul_of_differentiable_on_off_countable;
        specialize this ( Set.countable_singleton 0 ) ( show 0 ∈ Metric.ball 0 r from by simpa using hr.1 ) ( show ContinuousOn f ( Metric.closedBall 0 r ) from hf_analytic.continuousOn.mono ( Metric.closedBall_subset_ball hr.2 ) ) ( fun x hx => hf_analytic.differentiableAt ( IsOpen.mem_nhds Metric.isOpen_ball <| by simpa using hx.1.out.trans_le hr.2.le ) ) ; simp_all +decide [ div_eq_inv_mul ] ;
      simp_all +decide [ Complex.ext_iff ];
    simpa [ Complex.exp_mul_I ] using h_cauchy r hr;
  -- By the Dominated Convergence Theorem, we can take the limit as $r$ approaches $1$ inside the integral.
  have h_lim_integral : Filter.Tendsto (fun r : ℝ => ∫ θ in (0 : ℝ)..2 * Real.pi, f (r * (Real.cos θ + Real.sin θ * Complex.I))) (nhdsWithin 1 (Set.Iio 1)) (nhds (∫ θ in (0 : ℝ)..2 * Real.pi, f (Real.cos θ + Real.sin θ * Complex.I))) := by
    refine' intervalIntegral.tendsto_integral_filter_of_dominated_convergence _ _ _ _ _;
    use fun θ => hf_bounded.choose;
    · refine' Filter.eventually_of_mem ( Ioo_mem_nhdsLT zero_lt_one ) fun r hr => ContinuousOn.aestronglyMeasurable _ measurableSet_Ioc;
      refine' ContinuousOn.comp hf_analytic.continuousOn _ _;
      · fun_prop;
      · norm_num [ Set.MapsTo, Complex.norm_def, Complex.normSq ];
        norm_cast; norm_num [ ← sq ] ; intros; rw [ abs_of_pos hr.1 ] ; nlinarith [ hr.1, hr.2 ] ;
    · filter_upwards [ Ioo_mem_nhdsLT zero_lt_one ] with r hr;
      filter_upwards [ ] with x hx using hf_bounded.choose_spec _ <| mem_ball_zero_iff.mpr <| by simpa [ abs_of_pos hr.1, Complex.norm_exp ] using hr.2;
    · norm_num;
    · filter_upwards [ MeasureTheory.measure_eq_zero_iff_ae_notMem.mp ( hf_discontinuities.countable.measure_zero <| MeasureTheory.MeasureSpace.volume ) ] with x hx using fun _ => hf_radial x <| by aesop;
  exact tendsto_nhds_unique h_lim_integral ( Filter.Tendsto.congr' ( Filter.eventuallyEq_of_mem ( Ioo_mem_nhdsLT zero_lt_one ) fun x hx => by rw [ h_cont_integral x hx ] ) tendsto_const_nhds ) ▸ by norm_num;