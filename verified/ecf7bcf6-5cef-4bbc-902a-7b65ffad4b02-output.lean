/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: ecf7bcf6-5cef-4bbc-902a-7b65ffad4b02
-/

/-
We determine the limit of the function $f(x) = \lim_{n \to \infty} \frac{1}{n} \sum_{k=1}^n \cos^{2k}(k \pi x)$.
We prove that $f(x) = 1/q$ if $x = p/q$ is a rational number in lowest terms (with $q > 0$), and $f(x) = 0$ if $x$ is irrational.
This function is related to the Thomae function.
The proof handles the rational and irrational cases separately, using properties of cosine and density arguments.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
The function f(x) is defined as 1/q if x = p/q is rational (in lowest terms), and 0 if x is irrational.
-/
noncomputable def solution_169 (x : ℝ) : ℝ :=
  if h : ∃ (r : ℚ), (r : ℝ) = x then
    1 / ((Classical.choose h).den : ℝ)
  else
    0

/-
For coprime integers p, q with q > 0, |cos(k * p * pi / q)| = 1 if and only if q divides k.
-/
theorem abs_cos_eq_one_iff_dvd_denom {p q : ℤ} (hq : 0 < q) (hcoprime : Int.gcd p q = 1) (k : ℤ) :
    |Real.cos (k * p * Real.pi / q)| = 1 ↔ (q : ℤ) ∣ k := by
  norm_num [ Real.abs_cos_eq_sqrt_one_sub_sin_sq ];
  rw [ Real.sin_eq_zero_iff ];
  field_simp;
  norm_cast;
  exact ⟨ fun ⟨ n, hn ⟩ => Int.dvd_of_dvd_mul_left_of_gcd_one ( hn ▸ dvd_mul_left _ _ ) ( by simpa [ Int.gcd_comm ] using hcoprime ), fun ⟨ n, hn ⟩ => ⟨ n * p, by rw [ hn ] ; ring ⟩ ⟩

/-
The function |cos(k * p * pi / q)| is periodic in k with period q.
-/
theorem abs_cos_periodic {p q : ℤ} (k : ℤ) :
    |Real.cos ((k + q) * p * Real.pi / q)| = |Real.cos (k * p * Real.pi / q)| := by
  by_cases hq : q = 0 <;> simp +decide [ *, add_mul, mul_assoc, add_div ];
  norm_num [ Real.cos_add ]

/-
For coprime integers p, q with q > 0, there exists a constant C < 1 such that for all k not divisible by q, |cos(k * p * pi / q)| <= C.
-/
theorem abs_cos_le_const_of_not_dvd_denom {p q : ℤ} (hq : 0 < q) (hcoprime : Int.gcd p q = 1) :
    ∃ C < 1, ∀ k : ℤ, ¬(q : ℤ) ∣ k → |Real.cos (k * p * Real.pi / q)| ≤ C := by
  use ( SupSet.sSup ( Set.image ( fun k : ℤ => |Real.cos ( k * p * Real.pi / q )| ) ( Set.Ico 1 q ) ) );
  constructor;
  · -- Since $| \cos (k * p * \pi / q) | \neq 1$ for $k$ not divisible by $q$, we have $\sup_{k \in \{1, ..., q-1\}} | \cos (k * p * \pi / q) | < 1$.
    have h_sup_lt_one : ∀ k ∈ Set.Ico 1 q, |Real.cos (k * p * Real.pi / q)| < 1 := by
      intro k hk;
      have h_cos_ne_one : ¬(q : ℤ) ∣ k := by
        exact fun h => by linarith [ hk.1, hk.2, Int.le_of_dvd ( by linarith [ hk.1 ] ) h ] ;
      exact lt_of_le_of_ne ( Real.abs_cos_le_one _ ) fun h => h_cos_ne_one <| by have := abs_cos_eq_one_iff_dvd_denom hq hcoprime k; aesop;
    by_cases hq1 : q = 1;
    · aesop;
    · -- Since $q > 1$, the set $\{ | \cos (k * p * \pi / q) | : k \in \{1, ..., q-1\} \}$ is finite and thus has a maximum element.
      obtain ⟨M, hM⟩ : ∃ M ∈ Set.image (fun k : ℤ => |Real.cos (k * p * Real.pi / q)|) (Set.Ico 1 q), ∀ y ∈ Set.image (fun k : ℤ => |Real.cos (k * p * Real.pi / q)|) (Set.Ico 1 q), y ≤ M := by
        exact ( IsCompact.exists_isGreatest ( Set.Finite.isCompact <| Set.Finite.image _ <| Set.finite_Ico _ _ ) <| Set.Nonempty.image _ <| Set.nonempty_Ico.mpr <| lt_of_le_of_ne hq <| Ne.symm hq1 );
      exact lt_of_le_of_lt ( csSup_le ( Set.Nonempty.image _ <| Set.nonempty_Ico.mpr <| lt_of_le_of_ne hq <| Ne.symm hq1 ) hM.2 ) <| by obtain ⟨ k, hk₁, rfl ⟩ := hM.1; exact h_sup_lt_one k hk₁;
  · intro k hk_not_div
    obtain ⟨r, hr⟩ : ∃ r : ℤ, 1 ≤ r ∧ r < q ∧ k ≡ r [ZMOD q] := by
      exact ⟨ k % q, lt_of_le_of_ne ( Int.emod_nonneg _ hq.ne' ) ( Ne.symm <| by aesop ), Int.emod_lt_of_pos _ hq, Int.ModEq.symm <| Int.emod_emod_of_dvd _ <| dvd_refl _ ⟩;
    -- Since $k \equiv r \pmod{q}$, we have $| \cos(k * p * \pi / q) | = | \cos(r * p * \pi / q) |$.
    have h_cos_eq : |Real.cos (k * p * Real.pi / q)| = |Real.cos (r * p * Real.pi / q)| := by
      obtain ⟨ m, hm ⟩ := hr.2.2.symm.dvd;
      rw [ show ( k : ℝ ) = r + q * m by exact mod_cast eq_add_of_sub_eq' hm ] ; ring_nf; norm_num [ mul_assoc, mul_comm Real.pi _, hq.ne' ] ;
      rw [ Real.cos_add ] ; ring_nf ; norm_num [ hq.ne' ];
      norm_num [ show Real.cos ( p * Real.pi * m ) = ( -1 : ℝ ) ^ ( p * m ) by rw [ ← Real.rpow_intCast, eq_comm ] ; rw [ Real.rpow_def_of_nonpos ] <;> norm_num ; ring, show Real.sin ( p * Real.pi * m ) = 0 by exact Real.sin_eq_zero_iff.mpr ⟨ p * m, by push_cast; ring ⟩ ];
      cases' Int.even_or_odd ( p * m ) with h h <;> rw [ h.neg_zpow ] <;> norm_num;
    exact h_cos_eq.symm ▸ le_csSup ( by exact Set.Finite.bddAbove ( Set.Finite.image _ ( Set.finite_Ico _ _ ) ) ) ( Set.mem_image_of_mem _ ⟨ hr.1, hr.2.1 ⟩ )

/-
The density of multiples of q in {1, ..., n} tends to 1/q as n goes to infinity.
-/
theorem density_of_multiples (q : ℕ) (hq : q > 0) :
    Filter.Tendsto (λ (n : ℕ) => (∑ k ∈ Finset.range n, if q ∣ (k + 1) then (1 : ℝ) else 0) / n)
    Filter.atTop (nhds (1 / q)) := by
  -- The sum of multiples of q in the range 1 to n is equal to floor(n/q).
  have h_sum_multiples : ∀ n : ℕ, (∑ k ∈ Finset.range n, if q ∣ k + 1 then 1 else 0) = Nat.floor (n / q) := by
    intro n;
    induction n <;> simp_all +decide [ Nat.succ_div ];
    rw [ Finset.range_add_one, Finset.filter_insert ] ; aesop;
  -- We know that floor(n/q) / n tends to 1/q.
  have h_floor_div_n : Filter.Tendsto (fun n : ℕ => (Nat.floor (n / q) : ℝ) / n) Filter.atTop (nhds (1 / (q : ℝ))) := by
    -- We know that $\frac{\lfloor n/q \rfloor}{n}$ is squeezed between $\frac{1}{q} - \frac{1}{n}$ and $\frac{1}{q}$.
    have h_squeeze : ∀ n : ℕ, n > 0 → (1 / (q : ℝ)) - (1 / (n : ℝ)) ≤ (Nat.floor (n / q) : ℝ) / n ∧ (Nat.floor (n / q) : ℝ) / n ≤ (1 / (q : ℝ)) := by
      norm_num +zetaDelta at *;
      intro n hn; rw [ inv_eq_one_div, div_add', div_le_div_iff₀, div_le_div_iff₀ ] <;> norm_cast <;> try positivity;
      field_simp;
      exact ⟨ by norm_cast; linarith [ Nat.div_add_mod n q, Nat.mod_lt n hq ], by linarith [ Nat.div_mul_le_self n q ] ⟩;
    exact tendsto_of_tendsto_of_tendsto_of_le_of_le' ( by simpa using tendsto_const_nhds.sub ( tendsto_inverse_atTop_nhds_zero_nat ) ) tendsto_const_nhds ( Filter.eventually_atTop.mpr ⟨ 1, fun n hn => h_squeeze n hn |>.1 ⟩ ) ( Filter.eventually_atTop.mpr ⟨ 1, fun n hn => h_squeeze n hn |>.2 ⟩ );
  aesop

/-
The sum of `cos((k+1)p π/q)^(2(k+1))` over indices `k` where `q` does not divide `k+1` is summable.
-/
lemma summable_cos_pow_of_not_dvd {p q : ℤ} (hq : 0 < q) (hcoprime : Int.gcd p q = 1) :
    Summable (λ k : ℕ => if ¬(q : ℤ) ∣ (k + 1) then Real.cos ((k + 1) * p * Real.pi / q) ^ (2 * (k + 1)) else 0) := by
  by_contra h_contra;
  -- By the lemma `abs_cos_le_const_of_not_dvd_denom`, there exists a constant $C < 1$ such that for all $k$ not divisible by $q$, $|\cos(kp\pi/q)| \leq C$.
  obtain ⟨C, hC_lt_1, hC⟩ : ∃ C < 1, ∀ k : ℤ, ¬(q : ℤ) ∣ k → |Real.cos (k * p * Real.pi / q)| ≤ C := by
    exact?;
  -- Then the term is bounded by $C^{2(k+1)} = (C^2)^{k+1}$.
  have h_bound : ∀ k : ℕ, (if ¬(q : ℤ) ∣ (k + 1) then (Real.cos ((k + 1) * p * Real.pi / q)) ^ (2 * (k + 1)) else 0) ≤ (C ^ 2) ^ (k + 1) := by
    intro k; split_ifs <;> norm_num [ pow_mul ];
    · positivity;
    · exact pow_le_pow_left₀ ( sq_nonneg _ ) ( by simpa [ sq_le_sq ] using pow_le_pow_left₀ ( abs_nonneg _ ) ( hC ( k + 1 ) ‹_› ) 2 ) _;
  -- Since $C < 1$, the series $\sum_{k=1}^{\infty} (C^2)^{k+1}$ is a geometric series with ratio $C^2 < 1$, so it is summable.
  have h_geo_series : Summable (fun k : ℕ => (C ^ 2) ^ (k + 1)) := by
    have h_geo_series : Summable (fun k : ℕ => (C ^ 2) ^ k) := by
      refine' summable_geometric_of_lt_one _ _ <;> norm_num;
      · positivity;
      · rw [ abs_of_nonneg ] <;> have := hC 1 <;> norm_num at this;
        · linarith;
        · by_cases hq1 : q = 1;
          · norm_num [ hq1 ] at *;
            exact False.elim <| h_contra <| summable_zero;
          · exact le_trans ( abs_nonneg _ ) ( this ( by exact fun h => hq1 <| by linarith [ Int.le_of_dvd ( by positivity ) h ] ) );
    exact h_geo_series.comp_injective Nat.succ_injective;
  refine h_contra <| Summable.of_nonneg_of_le ( fun k => ?_ ) ( fun k => ?_ ) h_geo_series;
  · split_ifs <;> first | positivity | rw [ pow_mul ] ; positivity;
  · exact h_bound k

/-
If a series is summable, then the sequence of its partial sums divided by n tends to 0.
-/
lemma summable_implies_mean_tends_to_zero {f : ℕ → ℝ} (hf : Summable f) :
    Filter.Tendsto (λ n => (∑ k ∈ Finset.range n, f k) / n) Filter.atTop (nhds 0) := by
  simpa using hf.hasSum.tendsto_sum_nat.div_atTop tendsto_natCast_atTop_atTop

/-
For a rational number x = p/q (in lowest terms, q > 0), the limit of the average of cos^{2k}(k π x) is 1/q.
-/
theorem problem_169_rational (p q : ℤ) (hq : 0 < q) (hcoprime : Int.gcd p q = 1) :
    Filter.Tendsto (λ (n : ℕ) => (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * (p / q)) ^ (2 * (k + 1))) / n)
    Filter.atTop (nhds (1 / q)) := by
  -- Consider the sum $\sum_{k=0}^{n-1} \cos^{2(k+1)}((k+1)\pi p/q)$.
  suffices h_suff : Filter.Tendsto (fun n : ℕ => (∑ k ∈ Finset.range n, if (q : ℤ) ∣ (k + 1) then (1 : ℝ) else 0) / n) Filter.atTop (nhds (1 / q)) ∧ Summable (fun k : ℕ => if ¬(q : ℤ) ∣ (k + 1) then (Real.cos ((k + 1) * p * Real.pi / q)) ^ (2 * (k + 1)) else 0) by
    convert h_suff.1.add ( h_suff.2.hasSum.tendsto_sum_nat.div_atTop tendsto_natCast_atTop_atTop ) using 2 <;> norm_num ; ring;
    norm_num [ add_comm, mul_comm, mul_assoc, mul_left_comm, Finset.sum_ite ] ; ring;
    rw [ Finset.sum_filter ] ; ring;
    rw [ Finset.sum_congr rfl fun x hx => ?_ ];
    rw [ ← mul_add, Finset.card_filter ];
    rw [ Nat.cast_sum ] ; rw [ Finset.sum_add_distrib ];
    split_ifs <;> simp_all +decide [ ← even_iff_two_dvd, parity_simps ];
    -- Since $q \mid (x + 1)$, we have $\cos(\pi p (x + 1) / q) = \cos(k \pi) = (-1)^k$ for some integer $k$.
    obtain ⟨k, hk⟩ : ∃ k : ℤ, Real.pi * p * (x + 1) / q = k * Real.pi := by
      obtain ⟨ k, hk ⟩ := ‹q ∣ 1 + x›; use k * p; rw [ div_eq_iff ( by positivity ) ] ; push_cast [ ← @Int.cast_inj ℝ .. ] at *; linear_combination hk * Real.pi * p;
    rw [ show Real.pi * p * ( q : ℝ ) ⁻¹ + Real.pi * p * ( q : ℝ ) ⁻¹ * x = k * Real.pi by linear_combination' hk ] ; norm_num [ Real.cos_sq', pow_mul' ];
  constructor;
  · have := density_of_multiples ( q.natAbs ) ( by positivity );
    simp_all +decide [ ← Int.natCast_dvd_natCast, abs_of_pos hq ];
  · convert summable_cos_pow_of_not_dvd hq hcoprime using 1

/-
For an irrational number x and a non-zero integer m, the average of cos(2 * pi * m * k * x) for k from 0 to n-1 tends to 0 as n approaches infinity.
-/
lemma sum_cos_range_irrational (x : ℝ) (hx : Irrational x) (m : ℤ) (hm : m ≠ 0) :
    Filter.Tendsto (λ n => (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * m * k * x)) / n) Filter.atTop (nhds 0) := by
  -- The sum of cosines can be expressed using the formula for the sum of a geometric series.
  have h_geo_series : ∀ n : ℕ, ∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * m * k * x) = (Real.sin (2 * Real.pi * m * n * x / 2) * Real.cos (2 * Real.pi * m * (n - 1) * x / 2)) / Real.sin (Real.pi * m * x) := by
    intro n; induction' n with n ih <;> simp_all +decide [ Finset.sum_range_succ ] ; ring;
    rw [ Real.sin_add, Real.cos_sub ] ; ring;
    by_cases h : Real.sin ( Real.pi * m * x ) = 0 <;> simp_all +decide [ Real.sin_sq, Real.cos_sq ] ; ring;
    · rw [ Real.sin_eq_zero_iff ] at h;
      exact False.elim <| hx.ne_rat ( h.choose / m ) <| by push_cast; rw [ eq_div_iff <| Int.cast_ne_zero.mpr hm ] ; nlinarith [ Real.pi_pos, h.choose_spec ] ;
    · ring;
  -- Since $\sin(\pi m x)$ is non-zero and bounded, the numerator is bounded.
  have h_bounded : ∃ C : ℝ, ∀ n : ℕ, abs (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * m * k * x)) ≤ C := by
    simp_all +decide [ abs_div, abs_mul ];
    exact ⟨ 1 / |Real.sin ( Real.pi * m * x )|, fun n => mul_le_mul_of_nonneg_right ( mul_le_one₀ ( Real.abs_sin_le_one _ ) ( abs_nonneg _ ) ( Real.abs_cos_le_one _ ) ) ( by positivity ) ⟩;
  exact squeeze_zero_norm ( fun n => by simpa [ abs_div ] using div_le_div_of_nonneg_right ( h_bounded.choose_spec n ) ( Nat.cast_nonneg n ) ) ( tendsto_const_nhds.div_atTop tendsto_natCast_atTop_atTop )

/-
For irrational x and fixed M, the average of cos^{2M}(k pi x) tends to (2M choose M) / 4^M.
-/
lemma average_cos_pow_limit (x : ℝ) (hx : Irrational x) (M : ℕ) :
    Filter.Tendsto (λ n => (∑ k ∈ Finset.range n, Real.cos (Real.pi * k * x) ^ (2 * M)) / n)
    Filter.atTop (nhds ((Nat.choose (2 * M) M : ℝ) / 4 ^ M)) := by
  -- Using the identity $\cos^{2M}(\theta) = \frac{1}{2^{2M}} \sum_{j=0}^{2M} \binom{2M}{j} e^{i(2M-2j)\theta}$,
  -- we can express the limit in terms of exponential sums.
  have h_cos_pow_identity : ∀ k : ℕ, (Real.cos (Real.pi * k * x)) ^ (2 * M) = (1 / 4 ^ M) * ∑ j ∈ Finset.range (2 * M + 1), (Nat.choose (2 * M) j : ℝ) * Real.cos (2 * Real.pi * (M - j) * k * x) := by
    -- Using the binomial theorem, we expand $\cos^{2M}(\theta)$ as $\frac{1}{2^{2M}} \sum_{j=0}^{2M} \binom{2M}{j} e^{i(2M-2j)\theta}$.
    have h_cos_pow_binom : ∀ θ : ℝ, (Real.cos θ) ^ (2 * M) = (1 / 4 ^ M) * ∑ j ∈ Finset.range (2 * M + 1), (Nat.choose (2 * M) j : ℝ) * Complex.exp (Complex.I * (2 * M - 2 * j) * θ) := by
      -- Using the binomial theorem, we expand $(e^{i\theta} + e^{-i\theta})^{2M}$ as $\sum_{j=0}^{2M} \binom{2M}{j} e^{i(2M-2j)\theta}$.
      have h_binom : ∀ θ : ℝ, (Complex.exp (Complex.I * θ) + Complex.exp (-Complex.I * θ)) ^ (2 * M) = ∑ j ∈ Finset.range (2 * M + 1), (Nat.choose (2 * M) j : ℂ) * Complex.exp (Complex.I * (2 * M - 2 * j) * θ) := by
        intro θ; rw [ add_comm, add_pow ];
        norm_num [ ← Complex.exp_nat_mul, ← Complex.exp_add ];
        exact Finset.sum_congr rfl fun i hi => by rw [ Nat.cast_sub ( by linarith [ Finset.mem_range.mp hi ] ) ] ; push_cast; ring;
      simp_all +decide [ Complex.cos, ← mul_pow ];
      intro θ; rw [ div_pow, ← h_binom ] ; ring_nf; norm_num [ pow_mul' ] ;
    norm_num [ Complex.ext_iff ] at h_cos_pow_binom;
    norm_cast at *; simp_all +decide [ Complex.exp_re, Complex.exp_im ] ;
    intro k; rw [ show ( 16 : ℝ ) ^ M = 4 ^ M * 4 ^ M by rw [ ← mul_pow ] ; norm_num ] ; norm_num ; ring;
    ac_rfl;
  -- By the properties of the exponential function and the fact that $x$ is irrational, the average of the cosine terms tends to zero.
  have h_cos_avg_zero : ∀ j : ℕ, j ≠ M → Filter.Tendsto (fun n : ℕ => (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * (M - j) * k * x)) / (n : ℝ)) Filter.atTop (nhds 0) := by
    intro j hj_ne_M
    have h_cos_avg_zero : Filter.Tendsto (fun n : ℕ => (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * (M - j) * k * x)) / (n : ℝ)) Filter.atTop (nhds 0) := by
      have h_irrational : Irrational ((M - j) * x) := by
        exact_mod_cast hx.ratCast_mul ( show ( M - j : ℚ ) ≠ 0 from sub_ne_zero_of_ne <| mod_cast hj_ne_M.symm )
      have := @sum_cos_range_irrational ((M - j : ℝ) * x) h_irrational 1 (by norm_num);
      convert this using 4 ; ring;
    convert h_cos_avg_zero using 1;
  -- Applying the fact that the average of the cosine terms tends to zero, we can simplify the expression.
  have h_simplify : Filter.Tendsto (fun n : ℕ => (∑ j ∈ Finset.range (2 * M + 1), (Nat.choose (2 * M) j : ℝ) * (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * (M - j) * k * x))) / (n : ℝ)) Filter.atTop (nhds ((Nat.choose (2 * M) M : ℝ) * 1)) := by
    have h_simplify : Filter.Tendsto (fun n : ℕ => (∑ j ∈ Finset.range (2 * M + 1) \ {M}, (Nat.choose (2 * M) j : ℝ) * (∑ k ∈ Finset.range n, Real.cos (2 * Real.pi * (M - j) * k * x))) / (n : ℝ)) Filter.atTop (nhds 0) := by
      simpa [ Finset.sum_div _ _ _, mul_div_assoc ] using tendsto_finset_sum _ fun j hj => h_cos_avg_zero j ( by aesop ) |> Filter.Tendsto.const_mul _;
    simp_all +decide [ Finset.sum_eq_add_sum_diff_singleton ( Finset.mem_range.mpr ( show M < 2 * M + 1 from by linarith ) ) ];
    simpa [ add_div ] using Filter.Tendsto.add ( tendsto_const_nhds.congr' ( by filter_upwards [ Filter.eventually_ne_atTop 0 ] with n hn; simp +decide [ hn ] ) ) h_simplify;
  convert h_simplify.const_mul ( 1 / 4 ^ M ) using 2 <;> norm_num [ Finset.mul_sum _ _ _, Finset.sum_mul _ _ _, h_cos_pow_identity ] ; ring;
  · simp +decide only [mul_comm, mul_assoc, mul_left_comm, Finset.mul_sum _ _ _] ; ring;
    exact Finset.sum_comm.trans ( Finset.sum_congr rfl fun _ _ => Finset.sum_congr rfl fun _ _ => by ring );
  · ring

/-
The sequence (2M choose M) / 4^M tends to 0 as M approaches infinity.
-/
lemma limit_central_binomial_div_four_pow :
    Filter.Tendsto (λ M : ℕ => (Nat.choose (2 * M) M : ℝ) / 4 ^ M) Filter.atTop (nhds 0) := by
  -- We can use the fact that $\frac{\binom{2M}{M}}{4^M} \leq \frac{1}{\sqrt{M+1}}$ for all $M$.
  have h_bound : ∀ M : ℕ, (Nat.choose (2 * M) M : ℝ) / 4 ^ M ≤ 1 / Real.sqrt (M + 1) := by
    intro M;
    field_simp;
    -- Squaring both sides to remove the square root.
    suffices h_sq : (Nat.choose (2 * M) M : ℝ) ^ 2 * (M + 1) ≤ 4 ^ (2 * M) by
      rw [ pow_mul' ] at h_sq;
      nlinarith [ show 0 ≤ ( 4 : ℝ ) ^ M by positivity, Real.mul_self_sqrt ( by positivity : 0 ≤ ( M : ℝ ) + 1 ) ];
    induction' M with M ih <;> norm_num [ Nat.cast_succ, Nat.mul_succ, pow_succ', pow_mul' ] at *;
    have h_recurrence : (Nat.choose (2 * M + 2) (M + 1) : ℝ) = (Nat.choose (2 * M) M : ℝ) * (2 * M + 1) * 2 / (M + 1) := by
      rw [ Nat.cast_choose, Nat.cast_choose ] <;> try linarith;
      norm_num [ two_mul, add_assoc, Nat.factorial ];
      field_simp;
      norm_num [ Nat.add_sub_add_left, Nat.factorial_succ ] ; ring;
    rw [ h_recurrence, div_mul_div_comm, div_mul_eq_mul_div, div_le_iff₀ ] <;> try positivity;
    nlinarith [ sq ( M : ℝ ), show ( 0 : ℝ ) ≤ 4 ^ M * 4 ^ M by positivity ];
  exact squeeze_zero ( fun M => by positivity ) h_bound ( tendsto_const_nhds.div_atTop <| Filter.tendsto_atTop_atTop.mpr fun x => ⟨ Nat.ceil <| x ^ 2, fun n hn => Real.le_sqrt_of_sq_le <| by nlinarith [ Nat.ceil_le.mp hn ] ⟩ )

/-
The average of cos^{2M}((k+1) pi x) tends to the same limit as the average of cos^{2M}(k pi x).
-/
lemma average_cos_pow_limit_shift (x : ℝ) (hx : Irrational x) (M : ℕ) :
    Filter.Tendsto (λ n => (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * M)) / n)
    Filter.atTop (nhds ((Nat.choose (2 * M) M : ℝ) / 4 ^ M)) := by
  -- Notice that $\sum_{k=0}^{n-1} \cos((k+1)p \pi / q)^{2M}$ is the same as $\sum_{k=1}^{n} \cos(kp \pi / q)^{2M}$.
  have h_sum_shift : ∀ n : ℕ, (∑ k ∈ Finset.range n, (Real.cos (Real.pi * ((k + 1) : ℝ) * x) ^ (2 * M))) = (∑ k ∈ Finset.range (n + 1), (Real.cos (Real.pi * k * x) ^ (2 * M))) - (Real.cos (Real.pi * 0 * x) ^ (2 * M)) := by
    norm_num [ Finset.sum_range_succ' ];
  -- By definition of summation, we can split the limit into two parts:
  suffices h_split : Filter.Tendsto (fun n : ℕ => (∑ k ∈ Finset.range n, (Real.cos (Real.pi * k * x) ^ (2 * M))) / (n : ℝ)) Filter.atTop (nhds ((Nat.choose (2 * M) M : ℝ) / 4 ^ M)) ∧ Filter.Tendsto (fun n : ℕ => ((Real.cos (Real.pi * n * x)) ^ (2 * M)) / (n : ℝ)) Filter.atTop (nhds 0) by
    simp_all +decide [ Finset.sum_range_succ ];
    simpa [ add_div, sub_div ] using Filter.Tendsto.add ( Filter.Tendsto.add h_split.1 h_split.2 ) ( tendsto_inverse_atTop_nhds_zero_nat.neg );
  exact ⟨ by simpa using average_cos_pow_limit x hx M, tendsto_zero_iff_norm_tendsto_zero.mpr <| squeeze_zero ( fun _ => by positivity ) ( fun n => by simpa using div_le_div_of_nonneg_right ( pow_le_one₀ ( by positivity ) <| Real.abs_cos_le_one _ ) <| Nat.cast_nonneg _ ) <| tendsto_inverse_atTop_nhds_zero_nat ⟩

/-
For an irrational number x, the limit of the average of cos^{2k}(k π x) is 0.
-/
theorem problem_169_irrational (x : ℝ) (hx : Irrational x) :
    Filter.Tendsto (λ (n : ℕ) => (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * (k + 1))) / n)
    Filter.atTop (nhds 0) := by
  -- Let $a_k = \cos^{2(k+1)}((k+1)\pi x)$.
  set a : ℕ → ℝ := fun k => Real.cos (Real.pi * (k + 1) * x) ^ (2 * (k + 1));
  -- Since $a_k \ge 0$, it suffices to show $\limsup \frac{1}{n} \sum a_k \le \epsilon$ for any $\epsilon > 0$.
  suffices h_lim_sup : ∀ ε > 0, ∃ N : ℕ, ∀ n ≥ N, (∑ k ∈ Finset.range n, a k) / n ≤ ε by
    rw [ Metric.tendsto_nhds ];
    simp +zetaDelta at *;
    exact fun ε hε => by obtain ⟨ N, hN ⟩ := h_lim_sup ( ε / 2 ) ( half_pos hε ) ; exact ⟨ N, fun n hn => by rw [ abs_of_nonneg ( Finset.sum_nonneg fun _ _ => by rw [ pow_mul ] ; positivity ) ] ; linarith [ hN n hn ] ⟩ ;
  -- Fix $M$. For $k+1 \ge M$, we have $2(k+1) \ge 2M$, so $|\cos(\dots)|^{2(k+1)} \le |\cos(\dots)|^{2M}$.
  have h_bound : ∀ M : ℕ, ∀ n : ℕ, (∑ k ∈ Finset.range n, a k) ≤ (M : ℝ) + (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * M)) := by
    intros M n
    have h_le : ∀ k ∈ Finset.range n, a k ≤ if k < M - 1 then 1 else Real.cos (Real.pi * (k + 1) * x) ^ (2 * M) := by
      norm_num +zetaDelta at *;
      intro k hk; split_ifs <;> simp_all +decide [ pow_mul ] ;
      · exact pow_le_one₀ ( by positivity ) ( Real.cos_sq_le_one _ );
      · exact pow_le_pow_of_le_one ( sq_nonneg _ ) ( Real.cos_sq_le_one _ ) ( by linarith );
    refine le_trans ( Finset.sum_le_sum h_le ) ?_;
    norm_num [ Finset.sum_ite ];
    exact add_le_add ( mod_cast le_trans ( Finset.card_le_card <| show Finset.filter ( fun x => x < M - 1 ) ( Finset.range n ) ⊆ Finset.range ( M - 1 ) from fun x hx => Finset.mem_range.mpr <| Finset.mem_filter.mp hx |>.2 ) <| by simp +decide ) <| Finset.sum_le_sum_of_subset_of_nonneg ( fun x hx => by aesop ) fun _ _ _ => pow_mul ( Real.cos _ ) _ _ ▸ by positivity;
  -- Taking limsup as $n \to \infty$: $\limsup (S_n/n) \le 0 + \lim (T_{n,M}/n) = \binom{2M}{M}/4^M$.
  have h_lim_sup_M : ∀ M : ℕ, Filter.Tendsto (fun n : ℕ => (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * M)) / n) Filter.atTop (nhds ((Nat.choose (2 * M) M : ℝ) / 4 ^ M)) := by
    exact?;
  -- This holds for any $M$.
  intro ε hεpos
  obtain ⟨M, hM⟩ : ∃ M : ℕ, (Nat.choose (2 * M) M : ℝ) / 4 ^ M < ε / 2 := by
    have := limit_central_binomial_div_four_pow;
    exact ( this.eventually ( gt_mem_nhds <| half_pos hεpos ) ) |> fun h => h.exists;
  -- Choose $N$ such that for all $n \geq N$, we have $\frac{\sum_{k=0}^{n-1} \cos^{2M}((k+1)\pi x)}{n} \leq \frac{\epsilon}{2}$.
  obtain ⟨N, hN⟩ : ∃ N : ℕ, ∀ n ≥ N, (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * M)) / n ≤ ε / 2 := by
    exact Filter.eventually_atTop.mp ( h_lim_sup_M M |> fun h => h.eventually ( ge_mem_nhds <| by linarith ) );
  refine' ⟨ N + M + ⌈ ( M : ℝ ) / ( ε / 2 ) ⌉₊ + 1, fun n hn => _ ⟩ ; specialize hN n ( by linarith ) ; specialize h_bound M n ; rw [ div_le_iff₀ ] at * <;> norm_num at * <;> nlinarith [ Nat.le_ceil ( ( M : ℝ ) / ( ε / 2 ) ), mul_div_cancel₀ ( M : ℝ ) ( by linarith : ( ε / 2 ) ≠ 0 ), show ( n : ℝ ) ≥ N + M + ⌈ ( M : ℝ ) / ( ε / 2 ) ⌉₊ + 1 by exact_mod_cast hn ] ;

/-
The limit of the average of cos^{2k}(k π x) is given by the Thomae function solution_169(x).
-/
theorem problem_169 (x : ℝ) :
    Filter.Tendsto (λ (n : ℕ) => (∑ k ∈ Finset.range n, Real.cos (Real.pi * (k + 1) * x) ^ (2 * (k + 1))) / n)
    Filter.atTop (nhds (solution_169 x)) := by
  by_cases hx : ∃ r : ℚ, ( r : ℝ ) = x;
  · cases' hx with r hr;
    unfold solution_169;
    convert problem_169_rational r.num r.den ( Nat.cast_pos.mpr r.pos ) ( r.reduced ) using 2;
    · simp +decide [ ← hr, Rat.cast_def ];
    · split_ifs <;> aesop;
  · convert problem_169_irrational x ( fun ⟨ r, hr ⟩ => hx ⟨ r, hr ⟩ ) using 1;
    unfold solution_169; aesop;