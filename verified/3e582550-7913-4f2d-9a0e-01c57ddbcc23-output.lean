/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 3e582550-7913-4f2d-9a0e-01c57ddbcc23
-/

/-
We formalized the problem as finding the set of complex numbers $z$ for which the $n$-th term of the binomial series $\binom{z}{n}$ has the strictly largest absolute value.
We defined the binomial coefficient for complex numbers and the condition for strict maximality.
We proved that the set of such $z$ is the intersection of the open disk $|z-n| < n+1$ and the exterior of the closed disk $|z-(n-1)| \le n$ (for $n>0$).
The main theorem is `problem_12_solution`.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#check (0 : ℂ)
#check Complex.re
#check Complex.im

/-
The binomial coefficient binom(z, n) for complex z and natural n, defined as (z * (z-1) * ... * (z-n+1)) / n!.
-/
noncomputable def complexBinomial (z : ℂ) (n : ℕ) : ℂ :=
  ((List.range n).map (fun i => z - (i : ℂ))).prod / (n.factorial : ℂ)

/-
For a fixed n, the set of complex numbers z for which the n-th term of the binomial series is strictly greater in magnitude than all other terms is the region defined by |z-n| < n+1 and |z-(n-1)| > n (for n>0).
-/
/-- The condition that the $n$-th term is strictly larger in magnitude than all other terms. -/
def isStrictMax (z : ℂ) (n : ℕ) : Prop :=
  ∀ k, k ≠ n → ‖complexBinomial z n‖ > ‖complexBinomial z k‖

/-- The solution set for a given $n$. -/
def solutionSet (n : ℕ) (z : ℂ) : Prop :=
  ‖z - (n : ℂ)‖ < (n : ℝ) + 1 ∧ (n > 0 → ‖z - ((n : ℂ) - 1)‖ > (n : ℝ))

/-- Polya-Szego Problem 12: The set of $z$ for which the $n$-th term is strictly maximal
    is given by the intersection of the open disk $|z-n| < n+1$ and the exterior of the closed disk $|z-(n-1)| \le n$ (if $n>0$). -/
theorem problem_12_part_three_chapter_one (z : ℂ) (n : ℕ) :
    isStrictMax z n ↔ solutionSet n z := by
  unfold isStrictMax solutionSet;
  constructor;
  · intro h
    constructor;
    · contrapose! h;
      refine' ⟨ n + 1, _, _ ⟩ <;> simp_all +decide [ complexBinomial ];
      norm_num [ List.range_succ ];
      rw [ div_le_div_iff₀ ] <;> try positivity;
      rw [ mul_assoc ] ; gcongr ; norm_num [ Nat.factorial_succ ] ; nlinarith;
    · intro hn_pos
      have h_ratio : ‖complexBinomial z n‖ > ‖complexBinomial z (n - 1)‖ := by
        exact h _ ( Nat.pred_ne_self hn_pos.ne' );
      -- By definition of binomial coefficients, we know that
      have h_binom : complexBinomial z n = (z - (n - 1)) / n * complexBinomial z (n - 1) := by
        field_simp;
        unfold complexBinomial;
        rcases n <;> simp_all +decide [ List.range_succ, Nat.factorial ];
        rw [ mul_div, div_div ] ; ring;
      by_cases h : complexBinomial z ( n - 1 ) = 0 <;> simp_all +decide [ division_def ];
      rwa [ ← div_eq_mul_inv, one_lt_div ( by positivity ) ] at h_ratio;
  · -- We'll use that $|a_{n+1}| = |a_n| \cdot \left|\frac{z-n}{n+1}\right|$ and $|a_{n-1}| = |a_n| \cdot \left|\frac{n}{z-n+1}\right|$.
    have h_recurrence : ∀ k : ℕ, ‖complexBinomial z (k + 1)‖ = ‖complexBinomial z k‖ * ‖(z - k) / (k + 1)‖ := by
      unfold complexBinomial;
      norm_num [ List.range_succ ];
      intro k; norm_cast; norm_num [ Nat.factorial_succ ] ; ring;
      grind;
    -- Let's consider the two cases: $k < n$ and $k > n$.
    intro h_conditions k hk_ne_n
    by_cases hk_lt_n : k < n;
    · -- Since $k < n$, we have $|z - k| > k + 1$.
      have h_abs_gt : ∀ k < n, ‖z - k‖ > k + 1 := by
        intro k hk_lt_n
        induction' hk_lt_n with k hk ih;
        · aesop;
        · norm_num [ Complex.norm_def, Complex.normSq ] at *;
          rw [ Real.sqrt_lt' ] at * <;> try linarith;
          rw [ Real.lt_sqrt ] at * <;> try nlinarith;
          rename_i m hm;
          nlinarith [ show ( hm : ℝ ) + 1 ≤ k by norm_cast ];
      -- Applying the recurrence relation repeatedly, we get $|a_n| = |a_k| \cdot \prod_{i=k}^{n-1} \left|\frac{z-i}{i+1}\right|$.
      have h_prod : ‖complexBinomial z n‖ = ‖complexBinomial z k‖ * ∏ i ∈ Finset.Ico k n, ‖(z - i) / (i + 1)‖ := by
        have h_prod : ∀ m ≥ k, ‖complexBinomial z m‖ = ‖complexBinomial z k‖ * ∏ i ∈ Finset.Ico k m, ‖(z - i) / (i + 1)‖ := by
          intro m hm_ge_k; induction hm_ge_k <;> simp_all +decide [ Finset.prod_Ico_succ_top ] ;
          ring;
        exact h_prod n hk_lt_n.le;
      -- Since $|z - i| > i + 1$ for all $i \in \{k, k+1, \ldots, n-1\}$, we have $\prod_{i=k}^{n-1} \left|\frac{z-i}{i+1}\right| > 1$.
      have h_prod_gt_one : ∏ i ∈ Finset.Ico k n, ‖(z - i) / (i + 1)‖ > 1 := by
        have h_prod_gt_one : ∀ i ∈ Finset.Ico k n, ‖(z - i) / (i + 1)‖ > 1 := by
          simp +zetaDelta at *;
          exact fun i hi₁ hi₂ => by rw [ lt_div_iff₀ ( norm_pos_iff.mpr <| Nat.cast_add_one_ne_zero _ ) ] ; have := h_abs_gt i hi₂; norm_cast at *; aesop;
        exact lt_of_le_of_lt ( by norm_num [ hk_lt_n.le ] ) ( Finset.prod_lt_prod ( fun _ _ => by positivity ) ( fun i hi => by linarith [ h_prod_gt_one i hi ] ) ( show ∃ i, i ∈ Finset.Ico k n ∧ 1 < ‖ ( z - i : ℂ ) / ( i + 1 )‖ from ⟨ k, Finset.mem_Ico.mpr ⟨ le_rfl, hk_lt_n ⟩, h_prod_gt_one k ( Finset.mem_Ico.mpr ⟨ le_rfl, hk_lt_n ⟩ ) ⟩ ) );
      refine' h_prod.symm ▸ lt_mul_of_one_lt_right _ h_prod_gt_one;
      refine' norm_pos_iff.mpr _;
      intro H; specialize h_abs_gt k hk_lt_n; simp_all +decide [ complexBinomial ] ;
      rcases H with ( ⟨ a, ⟨ i, hi, rfl ⟩, hi' ⟩ | H ) <;> simp_all +decide [ sub_eq_iff_eq_add ];
      · norm_num [ Complex.norm_def, Complex.normSq ] at *;
        rw [ Real.sqrt_mul_self_eq_abs, abs_of_nonpos ] at h_abs_gt <;> linarith [ show ( i : ℝ ) + 1 ≤ k by norm_cast ];
      · exact Nat.factorial_ne_zero _ H;
    · -- Since $k > n$, we have $‖(z - k) / (k + 1)‖ < 1$.
      have h_ratio_lt_one : ∀ k : ℕ, n < k → ‖(z - k) / (k + 1)‖ < 1 := by
        intros k hk_gt_n
        have h_ratio_lt_one : ‖z - k‖ < k + 1 := by
          have h_ratio_lt_one : ‖z - k‖ ≤ ‖z - n‖ + (k - n) := by
            convert norm_add_le ( z - n ) ( - ( k - n : ℂ ) ) using 1 ; ring;
            norm_num [ Complex.norm_def, Complex.normSq ];
            rw [ Real.sqrt_mul_self_eq_abs, abs_of_nonpos ] <;> linarith [ show ( k : ℝ ) ≥ n + 1 by norm_cast ];
          linarith [ show ( k : ℝ ) ≥ n + 1 by norm_cast ];
        rw [ norm_div ];
        rw [ div_lt_iff₀ ] <;> norm_cast at * ; aesop;
        linarith;
      -- Since $k > n$, we can apply the recurrence relation repeatedly to get $‖complexBinomial z k‖ = ‖complexBinomial z n‖ * ∏_{i=n}^{k-1} ‖(z - i) / (i + 1)‖$.
      have h_prod_lt_one : ‖complexBinomial z k‖ = ‖complexBinomial z n‖ * ∏ i ∈ Finset.Ico n k, ‖(z - i) / (i + 1)‖ := by
        have h_prod_lt_one : ∀ m : ℕ, n ≤ m → ‖complexBinomial z m‖ = ‖complexBinomial z n‖ * ∏ i ∈ Finset.Ico n m, ‖(z - i) / (i + 1)‖ := by
          intro m hm; induction hm <;> simp_all +decide [ Finset.prod_Ico_succ_top ] ;
          ring;
        exact h_prod_lt_one k <| le_of_not_gt hk_lt_n;
      rw [h_prod_lt_one];
      refine' mul_lt_of_lt_one_right ( norm_pos_iff.mpr _ ) _;
      · intro h; simp_all +decide [ complexBinomial ] ;
        rcases h with ( ⟨ a, ⟨ i, hi, rfl ⟩, ha ⟩ | h ) <;> simp_all +decide [ sub_eq_iff_eq_add ];
        · norm_cast at * ; simp_all +decide [ Nat.dist_eq ];
          norm_num [ Int.subNatNat_eq_coe ] at *;
          exact absurd ( h_conditions.2 ( by linarith ) ) ( by cases abs_cases ( ( i : ℤ ) - ( n - 1 ) ) <;> linarith );
        · exact Nat.factorial_ne_zero _ h;
      · rw [ Finset.prod_eq_mul_prod_diff_singleton <| Finset.mem_Ico.mpr ⟨ le_rfl, lt_of_le_of_ne ( le_of_not_gt hk_lt_n ) hk_ne_n.symm ⟩ ];
        refine' lt_of_le_of_lt ( mul_le_of_le_one_right ( norm_nonneg _ ) ( Finset.prod_le_one ( fun _ _ => norm_nonneg _ ) fun _ _ => _ ) ) _;
        · exact le_of_lt ( h_ratio_lt_one _ ( lt_of_le_of_ne ( Finset.mem_Ico.mp ( Finset.mem_sdiff.mp ‹_› |>.1 ) |>.1 ) ( Ne.symm ( by aesop ) ) ) );
        · rw [ norm_div ];
          rw [ div_lt_iff₀ ] <;> norm_cast at * <;> aesop

lemma complexBinomial_succ (z : ℂ) (n : ℕ) :
    complexBinomial z (n + 1) = complexBinomial z n * (z - n) / (n + 1) := by
  unfold complexBinomial;
  norm_num [ List.range_succ, Nat.factorial_succ ];
  rw [ div_mul_eq_mul_div, div_div ] ; ring

lemma norm_complexBinomial_succ (z : ℂ) (n : ℕ) :
    ‖complexBinomial z (n + 1)‖ = ‖complexBinomial z n‖ * (‖z - n‖ / (n + 1)) := by
  rw [ complexBinomial_succ ];
  norm_num [ mul_div_assoc ];
  exact Or.inl <| by norm_cast;

lemma isStrictMax_of_ratio_conditions (z : ℂ) (n : ℕ)
    (h_inc : ∀ k < n, ‖complexBinomial z (k + 1)‖ > ‖complexBinomial z k‖)
    (h_dec : ∀ k ≥ n, ‖complexBinomial z (k + 1)‖ < ‖complexBinomial z k‖) :
    isStrictMax z n := by
  intro k hk;
  cases lt_or_gt_of_ne hk;
  · -- For $k < n$, we can use induction on $n - k$.
    induction' hk : n - k with m ih generalizing k;
    · omega;
    · grind;
  · induction ‹_›;
    · exact h_dec n le_rfl;
    · grind

lemma ratio_le_of_le (z : ℂ) (n k : ℕ) (h : n ≤ k) (cond : ‖z - n‖ < n + 1) :
    ‖z - k‖ < k + 1 := by
  -- Use the triangle inequality for complex numbers: ‖z - k‖ ≤ ‖z - n‖ + ‖n - k‖.
  have h_triangle : ‖z - (k : ℂ)‖ ≤ ‖z - (n : ℂ)‖ + ‖(n : ℂ) - (k : ℂ)‖ := by
    simpa using norm_add_le ( z - n ) ( n - k );
  by_cases hk : k = n <;> simp_all +decide [ sub_eq_iff_eq_add ];
  norm_cast at *;
  rw [ Int.subNatNat_eq_coe ] at * ; cases abs_cases ( n - k : ℤ ) <;> push_cast [ * ] at * <;> linarith [ show ( k : ℝ ) ≥ n + 1 by exact_mod_cast lt_of_le_of_ne h ( Ne.symm hk ) ]

lemma ratio_gt_of_gt (z : ℂ) (n k : ℕ) (h : k < n) (cond : ‖z - ((n : ℂ) - 1)‖ > n) :
    ‖z - k‖ > k + 1 := by
  have h_dist : ‖z - k‖ ≥ ‖z - (n - 1)‖ - ‖(n - 1 : ℂ) - k‖ := by
    simpa using norm_sub_le ( z - k ) ( ( n : ℂ ) - 1 - k );
  -- Since ‖(n - 1 : ℂ) - k‖ = |n - 1 - k| and n - 1 - k is a natural number, we have ‖(n - 1 : ℂ) - k‖ ≤ n - 1 - k.
  have h_norm : ‖(n - 1 : ℂ) - k‖ ≤ ↑(n - 1 - k) := by
    norm_cast;
    rw [ Int.subNatNat_of_le ];
    · rw [ Int.ofNat_sub ( Nat.le_sub_one_of_lt h ) ];
      rw [ abs_of_nonneg ( sub_nonneg_of_le ( mod_cast Nat.le_sub_one_of_lt h ) ) ];
    · linarith;
  rw [ Nat.cast_sub <| Nat.le_sub_one_of_lt h ] at * ; rw [ Nat.cast_sub <| by linarith ] at * ; norm_num at * ; linarith

theorem problem_12_solution (z : ℂ) (n : ℕ) :
    isStrictMax z n ↔ solutionSet n z := by
  rw [isStrictMax, solutionSet]
  constructor
  · intro h
    have h_ratio_succ : ‖complexBinomial z (n + 1)‖ < ‖complexBinomial z n‖ := by
      specialize h (n + 1) (by omega)
      exact h
    have h_ratio_pred : n > 0 → ‖complexBinomial z (n - 1)‖ < ‖complexBinomial z n‖ := by
      intro hn
      specialize h (n - 1) (by omega)
      exact h
    have h_ratio_succ : ‖z - (n : ℂ)‖ < (n : ℝ) + 1 := by
      rw [ norm_complexBinomial_succ ] at h_ratio_succ;
      nlinarith [ norm_nonneg ( complexBinomial z n ), mul_div_cancel₀ ( ‖z - ( n : ℂ )‖ ) ( by positivity : ( n : ℝ ) + 1 ≠ 0 ) ]
    have h_ratio_pred : n > 0 → ‖z - ((n : ℂ) - 1)‖ > (n : ℝ) := by
      intro hn_pos
      have h_ratio_pred_step : ‖complexBinomial z n‖ = ‖complexBinomial z (n - 1)‖ * (‖z - ((n : ℂ) - 1)‖ / (n : ℝ)) := by
        convert norm_complexBinomial_succ z ( n - 1 ) using 1 ; rcases n <;> aesop;
        cases n <;> aesop;
      have := h_ratio_pred hn_pos;
      contrapose! this;
      exact h_ratio_pred_step.symm ▸ mul_le_of_le_one_right ( norm_nonneg _ ) ( div_le_one_of_le₀ this ( by positivity ) )
    exact ⟨h_ratio_succ, h_ratio_pred⟩
  · rintro ⟨h_lt, h_gt⟩ k hk_ne_n
    have hn_ne_zero : complexBinomial z n ≠ 0 := by
      -- Since $z$ is not an integer less than $n$, none of the factors $(z - i)$ for $i < n$ are zero.
      have h_factors_nonzero : ∀ i < n, z - (i : ℂ) ≠ 0 := by
        intro i hi_lt_n hi_eq_zero; simp_all +decide [ sub_eq_iff_eq_add ] ;
        norm_num [ Complex.normSq, Complex.norm_def ] at *;
        exact not_le_of_gt ( h_gt ( pos_of_gt hi_lt_n ) ) ( Real.sqrt_le_iff.mpr ⟨ by positivity, by nlinarith [ show ( i : ℝ ) + 1 ≤ n by norm_cast ] ⟩ );
      exact div_ne_zero ( List.prod_ne_zero <| by aesop ) <| Nat.cast_ne_zero.mpr <| Nat.factorial_ne_zero _
    have h_inc : ∀ j < n, ‖complexBinomial z j‖ < ‖complexBinomial z (j + 1)‖ := by
      -- Use the ratio condition to show that ‖complexBinomial z (j + 1)‖ > ‖complexBinomial z j‖.
      intros j hj_lt_n
      have h_ratio : ‖z - (j : ℂ)‖ > (j + 1 : ℝ) := by
        -- Apply the ratio_gt_of_gt lemma with k = j and the condition from h_gt.
        have h_ratio_gt : ‖z - (j : ℂ)‖ > (j : ℝ) + 1 := by
          have h_cond : ‖z - ((n : ℂ) - 1)‖ > (n : ℝ) := by
            exact h_gt ( pos_of_gt hj_lt_n )
          -- Apply the ratio_gt_of_gt lemma with k = j and the condition from h_cond.
          apply ratio_gt_of_gt z n j hj_lt_n h_cond;
        exact h_ratio_gt;
      rw [ norm_complexBinomial_succ ];
      refine' lt_mul_of_one_lt_right _ _;
      · refine' norm_pos_iff.mpr _;
        intro H; simp_all +decide [ complexBinomial ] ;
        exact absurd ( H.resolve_right ( Nat.factorial_ne_zero _ ) ) ( by rintro ⟨ a, ⟨ k, hk_lt_j, rfl ⟩, hk ⟩ ; exact hn_ne_zero.1 _ _ ( by linarith ) rfl hk );
      · rwa [ one_lt_div ( by positivity ) ]
    have h_dec : ∀ j ≥ n, complexBinomial z j ≠ 0 → ‖complexBinomial z (j + 1)‖ < ‖complexBinomial z j‖ := by
      -- By definition of $complexBinomial$, we know that $‖complexBinomial z (j + 1)‖ = ‖complexBinomial z j‖ * (‖z - j‖ / (j + 1))$.
      intro j hj_ge_n hj_ne_zero
      have h_ratio : ‖complexBinomial z (j + 1)‖ = ‖complexBinomial z j‖ * (‖z - j‖ / (j + 1 : ℝ)) := by
        exact?;
      -- Since $j \geq n$ and $‖z - n‖ < n + 1$, we have $‖z - j‖ < j + 1$.
      have h_dist : ‖z - j‖ < j + 1 := by
        -- Apply the lemma that if ‖z - n‖ < n + 1 and n ≤ j, then ‖z - j‖ < j + 1.
        apply ratio_le_of_le z n j hj_ge_n h_lt;
      exact h_ratio.symm ▸ mul_lt_of_lt_one_right ( norm_pos_iff.mpr hj_ne_zero ) ( by rw [ div_lt_iff₀ ] <;> linarith )
    -- By the lemma isStrictMax_of_ratio_conditions, if the ratios are as stated, then z is in the solution set.
    apply (problem_12_part_three_chapter_one z n).mpr;
    · exact ⟨ h_lt, h_gt ⟩;
    · assumption