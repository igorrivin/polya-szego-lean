/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 3e52874a-8024-49f0-8c09-f085f9d485d7
-/

/-
We formalize Polya-Szego Problem 170, proving that for n ≥ 2, the fractional part of n!e is less than 3/(n+1).
The proof utilizes the Taylor series expansion of e and bounds the remainder term.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
For n ≥ 2, the fractional part of n!e satisfies n!e - ⌊n!e⌋ < 3/(n+1)
-/
theorem problem_170 (n : ℕ) (hn : n ≥ 2) :
    let e := Real.exp 1
    let factorial_n : ℕ := Nat.factorial n
    let n_factorial_e : ℝ := (factorial_n : ℝ) * e
    n_factorial_e - (⌊n_factorial_e⌋ : ℝ) < 3 / ((n : ℝ) + 1) := by
      -- We'll use that $n!e = k + \sum_{k=n+1}^{\infty} \frac{n!}{k!}$ where $k$ is an integer.
      have h_decomp : ∃ k : ℤ, n.factorial * Real.exp 1 = k + ∑' k : ℕ, (n.factorial : ℝ) / (Nat.factorial (n + k + 1)) := by
        rw [ Real.exp_eq_exp_ℝ ];
        norm_num [ NormedSpace.exp_eq_tsum_div ];
        rw [ ← Summable.sum_add_tsum_nat_add n.succ ];
        · norm_num [ div_eq_mul_inv, Finset.mul_sum _ _ _, mul_add, add_comm, add_left_comm, add_assoc ];
          norm_num [ Finset.mul_sum _ _ _, tsum_mul_left ];
          exact ⟨ ∑ i ∈ Finset.range ( n + 1 ), n.factorial / i.factorial, by push_cast; exact Finset.sum_congr rfl fun i hi => by rw [ ← div_eq_mul_inv ] ; rw [ Int.cast_div ( by exact_mod_cast Nat.factorial_dvd_factorial <| Finset.mem_range_succ_iff.mp hi ) ( by positivity ) ] ; push_cast; ring ⟩;
        · simpa using Real.summable_pow_div_factorial 1;
      -- We'll use that the sum of the series $\sum_{k=n+1}^{\infty} \frac{n!}{k!}$ is less than $\frac{3}{n+1}$.
      have h_sum_bound : ∑' k : ℕ, (n.factorial : ℝ) / (Nat.factorial (n + k + 1)) < 3 / (n + 1) := by
        -- We'll use that the series $\sum_{k=n+1}^{\infty} \frac{n!}{k!}$ is a geometric series with the first term $\frac{1}{n+1}$ and common ratio $\frac{1}{n+2}$.
        have h_geo_series : ∑' k : ℕ, (n.factorial : ℝ) / (Nat.factorial (n + k + 1)) ≤ ∑' k : ℕ, (1 : ℝ) / (n + 1) * (1 / (n + 2)) ^ k := by
          field_simp;
          refine' Summable.tsum_le_tsum _ _ _;
          · intro i; rw [ div_pow ] ; rw [ div_div ] ; rw [ div_le_div_iff₀ ] <;> norm_cast <;> first | positivity | induction i <;> simp_all +decide [ Nat.factorial, pow_succ' ];
            · linarith;
            · nlinarith [ Nat.zero_le ( n.factorial * ( n + 2 ) ^ ‹_› * ( n + 1 ) ) ];
          · exact Summable.mul_left _ <| by simpa using Summable.comp_injective ( Real.summable_pow_div_factorial 1 ) <| by intros a b; aesop;
          · exact Summable.mul_right _ ( summable_geometric_of_lt_one ( by positivity ) ( by rw [ div_lt_iff₀ ] <;> norm_cast <;> linarith ) );
        rw [ tsum_mul_left, tsum_geometric_of_lt_one ] at h_geo_series <;> norm_num at *;
        · exact h_geo_series.trans_lt ( by rw [ ← mul_inv, inv_eq_one_div, div_lt_div_iff₀ ] <;> nlinarith only [ show ( n : ℝ ) ≥ 2 by norm_cast, inv_mul_cancel₀ ( by positivity : ( n : ℝ ) + 2 ≠ 0 ) ] );
        · positivity;
        · exact inv_lt_one_of_one_lt₀ <| by linarith;
      norm_num +zetaDelta at *;
      rw [ h_decomp.choose_spec, Int.fract ];
      linarith [ show ( ⌊ ( h_decomp.choose : ℝ ) + ∑' k : ℕ, ( n.factorial : ℝ ) / ( n + k + 1 ).factorial⌋ : ℝ ) ≥ h_decomp.choose from mod_cast Int.le_floor.2 <| le_add_of_nonneg_right <| tsum_nonneg fun _ => by positivity ]