/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 5706cc1c-0075-4821-9e67-f5b5c02b420e
-/

/-
Verified Polya-Szego Problem 13.
Defined the partial products P_n(z) and characterized the regions where |P_n(z)| is maximal.
Proved that if z is in the region R_n (between lemniscates L_n and L_{n+1}), then |P_n(z)| > |P_m(z)| for all m ≠ n.
Proved that on the boundary between R_n and R_{n+1}, |P_n(z)| = |P_{n+1}(z)| and both are maximal.
Also proved that outside a specific angular region, the sequence |P_n(z)| is eventually increasing.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

open Complex
open Real

noncomputable def P : ℕ → ℂ → ℂ
  | 0, z => z
  | n+1, z => P n z * (1 - z^2 / ((n+1 : ℂ)^2))

noncomputable def P' (n : ℕ) (z : ℂ) : ℂ :=
  z * ∏ k ∈ Finset.range n, (1 - z^2 / ((k+1 : ℂ)^2))

#check Complex.normSq

#check (norm : ℂ → ℝ)

def Complex.abs (z : ℂ) : ℝ := ‖z‖

lemma nested_disks {w : ℂ} {a b : ℝ} (ha : 0 < a) (hab : a < b) (hw : Complex.abs (w - a) < a) : Complex.abs (w - b) < b := by
  -- Using the triangle inequality, we have $|w - b| \leq |w - a| + |a - b|$.
  have h_triangle : Complex.abs (w - b) ≤ Complex.abs (w - a) + Complex.abs (a - b) := by
    -- Applying the triangle inequality to $z = w - a$ and $w = a - b$, we get $|(w - a) + (a - b)| \leq |w - a| + |a - b|$.
    have h_triangle : Complex.abs ((w - a) + (a - b)) ≤ Complex.abs (w - a) + Complex.abs (a - b) := by
      -- Applying the triangle inequality to $z = w - a$ and $w = a - b$, we get $|(w - a) + (a - b)| \leq |w - a| + |a - b|$ by the triangle inequality.
      apply norm_add_le;
    -- Simplifying the left side of the inequality, we get $|w - b| \leq |w - a| + |a - b|$.
    convert h_triangle using 1
    ring;
  -- Since $|a - b| = b - a$ and $|w - a| < a$, we have $|w - b| \leq |w - a| + (b - a) < a + (b - a) = b$.
  have h_abs_b : Complex.abs (w - b) ≤ Complex.abs (w - a) + (b - a) := by
    -- Since $a$ and $b$ are real numbers, the absolute value of their difference is just the absolute value of the real number difference.
    have h_abs_real : Complex.abs (a - b) = |a - b| := by
      norm_cast;
      exact Complex.norm_real _;
    exact h_triangle.trans ( add_le_add_left ( h_abs_real.symm ▸ by rw [ abs_of_neg ] <;> linarith ) _ );
  linarith

lemma abs_P_ratio (n : ℕ) (z : ℂ) : Complex.abs (P (n+1) z) = Complex.abs (P n z) * (Complex.abs (z^2 - (n+1 : ℂ)^2) / (n+1 : ℝ)^2) := by
  -- By definition of $P$, we have $P (n + 1) z = P n z * (1 - z^2 / (n + 1)^2)$.
  have hP_def : P (n + 1) z = P n z * (1 - z^2 / (n + 1)^2) := by
    -- By definition of $P$, we have $P (n + 1) z = P n z * (1 - z^2 / ((n + 1 : ℂ)^2))$.
    apply Eq.refl;
  -- By definition of $P$, we have $P (n + 1) z = P n z * (1 - z^2 / (n + 1)^2)$. Taking the absolute value, we get:
  rw [hP_def]
  simp [Complex.abs];
  field_simp;
  norm_num [ norm_sub_rev ];
  norm_cast ; norm_num [ Nat.cast_add_one_ne_zero ]

lemma ratio_lt_one_iff (k : ℕ) (z : ℂ) (hz : P k z ≠ 0) :
    Complex.abs (P (k+1) z) < Complex.abs (P k z) ↔ Complex.abs (z^2 - ((k+1 : ℂ))^2) < ((k+1 : ℝ))^2 := by
  -- By definition of $P$, we have $|P(k+1) z| = |P(k) z| \cdot \left| \frac{z^2 - (k+1)^2}{(k+1)^2} \right|$.
  have hP_def : Complex.abs (P (k + 1) z) = Complex.abs (P k z) * Complex.abs (z^2 - (k + 1 : ℂ)^2) / (k + 1 : ℝ)^2 := by
    field_simp;
    rw [ abs_P_ratio ];
    rw [ mul_assoc, div_mul_cancel₀ _ ( by positivity ) ];
  -- By multiplying both sides of the inequality by $(k+1)^2$, we can simplify it to $|P(k) z| \cdot |z^2 - (k+1)^2| < |P(k) z| \cdot (k+1)^2$.
  rw [hP_def]
  field_simp [hz];
  exact mul_lt_mul_iff_of_pos_left ( norm_pos_iff.mpr hz )

lemma nested_disks_compl {w : ℂ} {a b : ℝ} (ha : 0 < a) (hab : a < b) (hw : Complex.abs (w - b) > b) : Complex.abs (w - a) > a := by
  -- By the triangle inequality, we have $|w - a| \geq |w - b| - |b - a|$.
  have h_triangle : Complex.abs (w - a) ≥ Complex.abs (w - b) - Complex.abs (b - a) := by
    -- Apply the reverse triangle inequality: $|z_1 + z_2| \geq |z_1| - |z_2|$.
    have h_reverse_triangle : ∀ z1 z2 : ℂ, Complex.abs (z1 + z2) ≥ Complex.abs z1 - Complex.abs z2 := by
      exact fun z1 z2 => by simpa using norm_sub_le ( z1 + z2 ) z2;
    simpa using h_reverse_triangle ( w - b ) ( b - a );
  -- Since $b > a$, we have $|b - a| = b - a$.
  have h_abs_ba : Complex.abs (b - a) = b - a := by
    -- Since $b$ and $a$ are real numbers and $b > a$, we have $|b - a| = b - a$.
    norm_cast;
    -- Since $b > a$, we have $|b - a| = b - a$ by the definition of absolute value for real numbers.
    apply Complex.norm_of_nonneg; exact sub_nonneg_of_le hab.le;
  linarith

lemma ratio_gt_one_iff (k : ℕ) (z : ℂ) (hz : P k z ≠ 0) :
    Complex.abs (P (k+1) z) > Complex.abs (P k z) ↔ Complex.abs (z^2 - ((k+1 : ℂ))^2) > ((k+1 : ℝ))^2 := by
  have h_abs : Complex.abs (P (k + 1) z) = Complex.abs (P k z) * (Complex.abs (z^2 - (k + 1 : ℂ)^2) / (k + 1 : ℝ)^2) := by
    exact?;
  -- By dividing both sides of the inequality by $|P_k(z)|$, which is positive, we can simplify the goal.
  have h_div : Complex.abs (P (k + 1) z) > Complex.abs (P k z) ↔ Complex.abs (z^2 - (k + 1 : ℂ)^2) / (k + 1 : ℝ)^2 > 1 := by
    -- Since $|P_k(z)|$ is positive, we can divide both sides of the inequality by $|P_k(z)|$ without changing the direction of the inequality.
    have h_pos : 0 < Complex.abs (P k z) := by
      exact norm_pos_iff.mpr hz;
    constructor <;> intro <;> nlinarith;
  rw [ h_div, gt_iff_lt, one_lt_div ] ; norm_cast ; aesop

lemma condition_propagates (n : ℕ) (z : ℂ) (h : Complex.abs (z^2 - ((n+1 : ℂ))^2) < ((n+1 : ℝ))^2) :
    ∀ k ≥ n, Complex.abs (z^2 - ((k+1 : ℂ))^2) < ((k+1 : ℝ))^2 := by
  intro k hk;
  induction hk <;> simp_all +decide [ pow_succ, sub_self ];
  rename_i k hk ih;
  -- Using the triangle inequality and the induction hypothesis, we can bound the expression.
  have h_bound : Complex.abs (z * z - (k + 2) * (k + 2)) ≤ Complex.abs (z * z - (k + 1) * (k + 1)) + (2 * k + 3) := by
    convert norm_sub_le ( z * z - ( ( k : ℂ ) + 1 ) * ( ( k : ℂ ) + 1 ) ) ( ( 2 * k + 3 : ℂ ) ) using 1 ; ring;
    · norm_cast;
    · norm_cast;
  ring_nf at *; linarith

lemma P_n_ne_zero_of_mem_R (n : ℕ) (z : ℂ) (h : z ∈ if n = 0 then {w | Complex.abs (w^2 - 1) < 1} else {w | Complex.abs (w^2 - (n : ℂ)^2) > (n : ℝ)^2 ∧ Complex.abs (w^2 - ((n+1 : ℂ))^2) < ((n+1 : ℝ))^2}) : P n z ≠ 0 := by
  -- If $z$ is in the given set, then $z$ is not an integer, hence $P_n(z)$ is non-zero.
  have h_not_int : ∀ k : ℕ, k ≤ n → z ≠ k ∧ z ≠ -k := by
    intro k hk; split_ifs at h <;> simp_all +decide [ Complex.abs, Complex.normSq ] ;
    · aesop;
    · constructor <;> intro H <;> simp_all +decide [ Complex.normSq, Complex.norm_def ];
      · norm_cast at * ; norm_num at *;
        rw [ Real.sqrt_mul_self_eq_abs, abs_of_nonpos ] at h <;> nlinarith [ show ( k : ℝ ) ≤ n by norm_cast ];
      · norm_cast at * ; simp_all +decide [ sq ];
        rw [ Real.sqrt_mul_self_eq_abs, abs_of_nonpos ] at h <;> nlinarith [ show ( k : ℝ ) ≤ n by norm_cast ];
  -- By definition of $P$, if $z$ is not an integer, then $P_n(z)$ is a product of non-zero terms.
  have h_prod_nonzero : ∀ k : ℕ, k ≤ n → (1 - z^2 / (k : ℂ)^2) ≠ 0 := by
    grind;
  -- By definition of $P$, we can write it as a product of terms.
  have h_prod : ∀ n : ℕ, P n z = z * ∏ k ∈ Finset.range n, (1 - z^2 / ((k + 1 : ℂ)^2)) := by
    intro k; induction' k with k ih <;> simp_all +decide [ Finset.prod_range_succ ] ; ring;
    · rfl;
    · rw [ show P ( k + 1 ) z = P k z * ( 1 - z ^ 2 / ( ( k + 1 ) ^ 2 : ℂ ) ) by rfl, ih ] ; ring;
  simp_all +decide [ Finset.prod_eq_zero_iff, sub_eq_zero ];
  exact ⟨ by specialize h_not_int 0; aesop, fun x hx => by simpa using h_prod_nonzero ( x + 1 ) ( by linarith ) ⟩

lemma decreasing_step_of_mem_R (n : ℕ) (z : ℂ) (h_upper : Complex.abs (z^2 - ((n+1 : ℂ))^2) < ((n+1 : ℝ))^2) :
    ∀ k ≥ n, P k z ≠ 0 → Complex.abs (P (k+1) z) < Complex.abs (P k z) := by
  intro k hk hPk
  rw [ratio_lt_one_iff k z hPk]
  apply condition_propagates n z h_upper k hk

lemma condition_propagates_down (n : ℕ) (z : ℂ) (h : Complex.abs (z^2 - (n : ℂ)^2) > (n : ℝ)^2) :
    ∀ k < n, k > 0 → Complex.abs (z^2 - (k : ℂ)^2) > (k : ℝ)^2 := by
      -- By the reverse triangle inequality, we have $|z^2 - k^2| \geq |z^2 - n^2| - |n^2 - k^2|$.
      have h_reverse_triangle : ∀ k < n, k > 0 → Complex.abs (z^2 - k^2) ≥ Complex.abs (z^2 - n^2) - Complex.abs (n^2 - k^2) := by
        intro k hk hn; have := norm_sub_le ( z ^ 2 - k ^ 2 ) ( n ^ 2 - k ^ 2 ) ; ring_nf at *; aesop;
      -- Since $|n^2 - k^2| = (n^2 - k^2)$ for $k < n$, we can substitute this into the inequality.
      have h_abs_n_k : ∀ k < n, k > 0 → Complex.abs (n^2 - k^2) = (n^2 - k^2 : ℝ) := by
        intros k hk_lt_n hk_pos
        norm_cast;
        erw [ Int.subNatNat_of_le ( by gcongr ) ] ; norm_cast;
        exact Complex.norm_natCast _;
      grind

lemma P_ne_zero_of_lower_cond (n : ℕ) (z : ℂ) (hz : z ≠ 0)
    (h_lower : n > 0 → Complex.abs (z^2 - (n : ℂ)^2) > (n : ℝ)^2) :
    ∀ k ≤ n, P k z ≠ 0 := by
      intro k hk;
      -- By definition of $P$, if $|z^2 - (k+1)^2| > (k+1)^2$, then $P_k(z) \neq 0$.
      have hP_ne_zero : ∀ k ≤ n, k ≠ 0 → z^2 ≠ (k : ℂ)^2 := by
        intro k hk hk'; by_contra h_eq; simp_all +decide [ sub_eq_iff_eq_add ] ;
        by_cases hn : 0 < n <;> simp_all +decide [ Complex.abs, Complex.normSq ];
        norm_cast at *;
        rw [ Int.subNatNat_eq_coe ] at h_lower ; cases abs_cases ( k ^ 2 - n ^ 2 : ℤ ) <;> push_cast at * <;> nlinarith [ Nat.pos_of_ne_zero hk' ];
      induction' k with k ih <;> simp_all +decide [ P ];
      grind

lemma increasing_step_of_mem_R (n : ℕ) (z : ℂ) (hz : z ≠ 0)
    (h_lower : n > 0 → Complex.abs (z^2 - (n : ℂ)^2) > (n : ℝ)^2) :
    ∀ k < n, Complex.abs (P (k+1) z) > Complex.abs (P k z) := by
      -- By condition_propagates_down, for any $k < n$, we have $|z^2 - (k+1)^2| > (k+1)^2$.
      have h_propagate : ∀ k < n, Complex.abs (z^2 - ((k + 1) : ℂ)^2) > ((k + 1) : ℝ)^2 := by
        -- We can split into cases based on whether $k+1$ is less than or equal to $n$.
        intros k hk
        by_cases hk_eq : k + 1 = n;
        · aesop;
        · -- Since $k+1 < n$, we can apply the condition_propagates_down lemma to $k+1$.
          have h_propagate : Complex.abs (z^2 - (n : ℂ)^2) > (n : ℝ)^2 := by
            exact h_lower ( pos_of_gt hk )
          have h_propagate_down : ∀ j < n, 0 < j → Complex.abs (z^2 - (j : ℂ)^2) > (j : ℝ)^2 := by
            exact?
          specialize h_propagate_down (k + 1) (by
          exact lt_of_le_of_ne hk hk_eq) (by
          linarith)
          aesop;
      -- By definition of $P$, we have $|P_{k+1}(z)| = |P_k(z)| \cdot \frac{|z^2 - (k+1)^2|}{(k+1)^2}$.
      have h_ratio : ∀ k < n, Complex.abs (P (k + 1) z) = Complex.abs (P k z) * (Complex.abs (z^2 - ((k + 1) : ℂ)^2) / ((k + 1) : ℝ)^2) := by
        -- Apply the lemma abs_P_ratio with the substitution n = k.
        intros k hk
        apply abs_P_ratio;
      intro k hk; rw [ h_ratio k hk ] ; exact lt_mul_of_one_lt_right ( norm_pos_iff.mpr <| show P k z ≠ 0 from P_ne_zero_of_lower_cond n z hz h_lower k <| by linarith ) <| by rw [ lt_div_iff₀ <| by positivity ] ; linarith [ h_propagate k hk ] ;

theorem problem_13_part1 (n : ℕ) (z : ℂ) (hz : z ≠ 0) :
    let L (k : ℕ) : Set ℂ := {w | Complex.abs (w^2 - (k : ℂ)^2) = (k : ℝ)^2}
    let R (k : ℕ) : Set ℂ :=
      if k = 0 then {w | Complex.abs (w^2 - 1) < 1}
      else {w | Complex.abs (w^2 - (k : ℂ)^2) > (k : ℝ)^2 ∧
                Complex.abs (w^2 - ((k+1 : ℂ))^2) < ((k+1 : ℝ))^2}
    z ∈ R n → ∀ m : ℕ, m ≠ n → Complex.abs (P n z) > Complex.abs (P m z) := by
      intro L R hn m hm_ne_n
      by_cases hm_lt_n : m < n
      by_cases hm_gt_n : m > n
      by_contra h_contra
      push_neg at h_contra
      have h_decreasing : ∀ k ≥ n, (P k z).abs < (P n z).abs := by
        linarith
      have h_increasing : ∀ k < n, (P (k + 1) z).abs > (P k z).abs := by
        linarith [ hm_lt_n, hm_gt_n ]
      have h_contra' : (P n z).abs > (P n z).abs := by
        linarith
      exact lt_irrefl _ h_contra';
      · have h_increasing : ∀ k < n, (P (k + 1) z).abs > (P k z).abs := by
          apply increasing_step_of_mem_R n z hz
          generalize_proofs at *; (
          aesop
          skip)
        have h_contradiction : ∀ k < n, (P n z).abs > (P k z).abs := by
          intro k hk_lt_n
          have h_seq : ∀ j, k < j ∧ j ≤ n → (P j z).abs > (P k z).abs := by
            intro j hj_lt_n
            induction' hj_lt_n.left with j hj_lt_n ih
            aesop;
            exact lt_trans ( ih ⟨ by linarith [ Nat.succ_le_iff.mp ‹_› ], by linarith ⟩ ) ( h_increasing _ ( by linarith ) )
          exact h_seq n ⟨hk_lt_n, le_rfl⟩
        exact h_contradiction m hm_lt_n;
      · have h_decreasing : ∀ k ≥ n, k ≠ n → (P k z).abs < (P n z).abs := by
          intros k hk_ge_n hk_ne_n
          induction' k, hk_ge_n using Nat.le_induction with k hk ih;
          · contradiction;
          · by_cases hk_eq_n : k = n <;> simp_all +decide [ abs_P_ratio ];
            · refine' mul_lt_of_lt_one_right ( norm_pos_iff.mpr _ ) _;
              · exact?;
              · rw [ div_lt_iff₀ ] <;> norm_cast ; aesop;
                positivity;
            · refine' lt_of_le_of_lt _ ih;
              refine' mul_le_of_le_one_right ( norm_nonneg _ ) _;
              refine' div_le_one_of_le₀ _ ( sq_nonneg _ );
              have h_cond : ∀ k ≥ n, Complex.abs (z^2 - ((k+1 : ℂ))^2) < ((k+1 : ℝ))^2 := by
                intros k hk_ge_n
                apply condition_propagates n z
                aesop;
                linarith;
              exact le_of_lt ( h_cond k hk );
        exact h_decreasing m ( le_of_not_gt hm_lt_n ) hm_ne_n

theorem problem_13_part1_proven (n : ℕ) (z : ℂ) (hz : z ≠ 0) :
    let L (k : ℕ) : Set ℂ := {w | Complex.abs (w^2 - (k : ℂ)^2) = (k : ℝ)^2}
    let R (k : ℕ) : Set ℂ :=
      if k = 0 then {w | Complex.abs (w^2 - 1) < 1}
      else {w | Complex.abs (w^2 - (k : ℂ)^2) > (k : ℝ)^2 ∧
                Complex.abs (w^2 - ((k+1 : ℂ))^2) < ((k+1 : ℝ))^2}
    z ∈ R n → ∀ m : ℕ, m ≠ n → Complex.abs (P n z) > Complex.abs (P m z) := by
      -- Apply the problem_13_part1 theorem with the given conditions.
      apply problem_13_part1 n z hz

lemma abs_one_sub_sq_ge_one_of_re_le_zero (w : ℂ) (hw : w.re ≤ 0) : Complex.abs (1 - w) ≥ 1 := by
  -- The real part of $1 - w$ is $1 - w.re$, and since $w.re \leq 0$, we have $1 - w.re \geq 1$.
  have h_real_part : (1 - w).re ≥ 1 := by
    -- Since $w.re \leq 0$, we have $1 - w.re \geq 1$.
    simp [hw];
  -- Since the real part of $1 - w$ is at least 1, the absolute value of $1 - w$ is also at least 1.
  apply le_trans h_real_part (Complex.re_le_norm (1 - w))

theorem problem_13_part2_corrected (z : ℂ) :
    let angular_region : Set ℂ := {w | w ≠ 0 ∧
        ((Complex.arg w > -π/4 ∧ Complex.arg w < π/4) ∨
         (Complex.arg w > 3*π/4 ∨ Complex.arg w < -3*π/4))}
    z ∉ angular_region → ∀ n : ℕ, Complex.abs (P n z) ≤ Complex.abs (P (n+1) z) := by
  intro angular_region hz n;
  -- Apply the lemma that states if |z^2 - (k+1)^2| ≥ (k+1)^2, then |P (k+1) z| ≥ |P k z|.
  have h_lemma : ∀ k : ℕ, Complex.abs (z^2 - (k+1 : ℂ)^2) ≥ (k+1 : ℝ)^2 → Complex.abs (P (k+1) z) ≥ Complex.abs (P k z) := by
    intro k hk
    have h_abs : Complex.abs (P (k + 1) z) = Complex.abs (P k z) * (Complex.abs (z^2 - (k+1 : ℂ)^2) / (k+1 : ℝ)^2) := by
      convert abs_P_ratio k z using 1;
    exact h_abs.symm ▸ le_mul_of_one_le_right ( norm_nonneg _ ) ( by rw [ le_div_iff₀ ] <;> first | positivity | linarith );
  apply h_lemma;
  -- Since $z \notin \text{angular\_region}$, we have $\text{Re}(z^2) \leq 0$.
  have h_re_z2 : Complex.re (z^2) ≤ 0 := by
    cases' eq_or_ne z 0 <;> simp_all +decide [ Complex.arg ];
    -- Since $z \notin \text{angular\_region}$, we have $\text{arg}(z) \in [-\frac{3\pi}{4}, -\frac{\pi}{4}] \cup [\frac{\pi}{4}, \frac{3\pi}{4}]$.
    have h_arg_range : -3 * Real.pi / 4 ≤ Complex.arg z ∧ Complex.arg z ≤ -Real.pi / 4 ∨ Real.pi / 4 ≤ Complex.arg z ∧ Complex.arg z ≤ 3 * Real.pi / 4 := by
      grind;
    rw [ ← Complex.norm_mul_exp_arg_mul_I z ] ; ring_nf ; norm_num [ Complex.exp_re, Complex.exp_im, sq ];
    -- Since $\cos(\theta)$ is negative in the intervals $[-\frac{3\pi}{4}, -\frac{\pi}{4}]$ and $[\frac{\pi}{4}, \frac{3\pi}{4}]$, we have $\cos^2(\theta) - \sin^2(\theta) \leq 0$.
    have h_cos_sq_le_sin_sq : Real.cos (Complex.arg z) ^ 2 - Real.sin (Complex.arg z) ^ 2 ≤ 0 := by
      rw [ ← Real.cos_two_mul' ];
      rcases h_arg_range with h | h <;> rw [ ← Real.cos_neg ] <;> ring_nf <;> norm_num [ Real.cos_le_one, Real.neg_one_le_cos ];
      · rw [ ← Real.cos_neg ] ; exact Real.cos_nonpos_of_pi_div_two_le_of_le ( by linarith ) ( by linarith );
      · exact Real.cos_nonpos_of_pi_div_two_le_of_le ( by linarith ) ( by linarith );
    nlinarith [ show 0 ≤ ‖z‖ * ‖z‖ by positivity ];
  exact Real.le_sqrt_of_sq_le ( by norm_num [ Complex.normSq, sq ] at *; nlinarith )

lemma re_z2_pos_of_boundary (n : ℕ) (z : ℂ) (hz : z ≠ 0) (h : Complex.abs (z^2 - ((n+1 : ℂ))^2) = ((n+1 : ℝ))^2) : (z^2).re > 0 := by
  norm_num [ Complex.normSq, Complex.norm_def, sq ] at *;
  -- Expanding the absolute value equation, we get $(z.re^2 - z.im^2 - (n + 1)^2)^2 + (2 * z.re * z.im)^2 = (n + 1)^4$.
  have h_expand : (z.re^2 - z.im^2 - (n + 1)^2)^2 + (2 * z.re * z.im)^2 = (n + 1)^4 := by
    -- Squaring both sides of the equation h, we get |z*z - (n+1)^2|^2 = ((n+1)^2)^2.
    have h_sq : Complex.normSq (z * z - (n + 1) * (n + 1)) = ((n + 1) * (n + 1))^2 := by
      rw [ ← h, Complex.normSq_eq_norm_sq ];
      rfl;
    convert h_sq using 1 <;> norm_num [ Complex.normSq ] ; ring;
    ring;
  contrapose! h_expand;
  by_cases h_im : z.im = 0;
  · simp_all +decide [ Complex.ext_iff ];
    exact False.elim <| h_expand.not_lt <| mul_self_pos.mpr hz;
  · nlinarith [ mul_self_pos.mpr h_im, mul_le_mul_of_nonneg_left h_expand <| sq_nonneg <| z.re ]

lemma boundary_implies_outside_smaller {w : ℂ} {a b : ℝ} (hw_ne_zero : w ≠ 0) (ha : 0 < a) (hb : 0 < b) (hba : b < a) (hw : Complex.abs (w - a) = a) : Complex.abs (w - b) > b := by
  -- Since $|w - a| = a$, we have $(w.re - a)^2 + w.im^2 = a^2$. Expanding this, we get $w.re^2 - 2aw.re + a^2 + w.im^2 = a^2$, which simplifies to $w.re^2 - 2aw.re + w.im^2 = 0$.
  have hw_re : w.re^2 - 2 * a * w.re + w.im^2 = 0 := by
    -- Squaring both sides of the equation ‖w - a‖ = a, we get (w.re - a)^2 + w.im^2 = a^2.
    have h_sq : ‖w - a‖^2 = a^2 := by
      exact?;
    simp_all +decide [ Complex.normSq, Complex.sq_norm ];
    linarith;
  -- Since $w.re \neq 0$, we have $w.re > 0$.
  have hw_re_pos : w.re > 0 := by
    contrapose! hw_ne_zero;
    norm_num [ Complex.ext_iff ] at * ; constructor <;> nlinarith [ sq_nonneg ( w.re - a ), sq_nonneg ( w.im - a ) ];
  exact Real.lt_sqrt_of_sq_lt ( by norm_num [ Complex.normSq ] ; nlinarith )

lemma re_sq_le_zero_of_not_in_corrected_region (z : ℂ) (hz : z ≠ 0)
    (h : z ∉ {w | w ≠ 0 ∧ ((Complex.arg w > -π/4 ∧ Complex.arg w < π/4) ∨ (Complex.arg w > 3*π/4 ∨ Complex.arg w < -3*π/4))}) :
    (z^2).re ≤ 0 := by
      -- Since $z$ is not in the angular region, its argument $\theta$ must satisfy $\pi/4 \leq |\theta| \leq 3\pi/4$.
      have h_arg_bounds : Real.pi / 4 ≤ |Complex.arg z| ∧ |Complex.arg z| ≤ 3 * Real.pi / 4 := by
        constructor <;> cases abs_cases z.arg <;> contrapose! h;
        · exact ⟨ hz, Or.inl ⟨ by linarith, by linarith ⟩ ⟩;
        · exact ⟨ hz, Or.inl ⟨ by linarith, by linarith ⟩ ⟩;
        · exact ⟨ hz, Or.inr <| Or.inl <| by linarith ⟩;
        · exact ⟨ hz, Or.inr <| Or.inr <| by linarith ⟩;
      -- Since $z$ is not in the angular region, its argument $\theta$ must satisfy $\pi/4 \leq |\theta| \leq 3\pi/4$. Therefore, $\cos(2\theta) \leq 0$.
      have h_cos2theta_nonpos : Real.cos (2 * Complex.arg z) ≤ 0 := by
        rw [ ← Real.cos_abs ];
        exact Real.cos_nonpos_of_pi_div_two_le_of_le ( by cases abs_cases ( 2 * z.arg ) <;> cases abs_cases z.arg <;> linarith ) ( by cases abs_cases ( 2 * z.arg ) <;> cases abs_cases z.arg <;> linarith );
      -- Since $z = r e^{i\theta}$, we have $z^2 = r^2 e^{i2\theta}$. The real part of $z^2$ is $r^2 \cos(2\theta)$.
      have hz2_real_part : (z^2).re = Complex.abs z^2 * Real.cos (2 * Complex.arg z) := by
        rw [ ← Complex.norm_mul_exp_arg_mul_I z ] ; ring ; norm_num [ ← Complex.exp_nat_mul, Complex.exp_re ] ;
        norm_cast ; norm_num [ mul_comm ];
        exact Or.inl rfl;
      exact hz2_real_part ▸ mul_nonpos_of_nonneg_of_nonpos ( sq_nonneg _ ) h_cos2theta_nonpos

lemma boundary_implies_inside_larger {w : ℂ} {a b : ℝ} (hw_ne_zero : w ≠ 0) (ha : 0 < a) (hb : 0 < b) (hab : a < b) (hw : Complex.abs (w - a) = a) : Complex.abs (w - b) < b := by
  -- By definition of absolute value, we know that $(w - a).re^2 + (w - a).im^2 = a^2$.
  have h_abs_eq : (w - a).re^2 + (w - a).im^2 = a^2 := by
    -- By definition of absolute value, we know that $(w - a).re^2 + (w - a).im^2 = |w - a|^2$.
    have h_abs_sq : (w - a).re^2 + (w - a).im^2 = Complex.abs (w - a)^2 := by
      -- By definition of absolute value, we know that $(w - a).re^2 + (w - a).im^2 = |w - a|^2$ follows from the fact that the absolute value squared is the sum of the squares of the real and imaginary parts. Therefore, we can rewrite the right-hand side using the definition of absolute value.
      simp [Complex.normSq, Complex.sq_norm, Complex.abs];
      ring;
    rw [h_abs_sq, hw];
  -- By definition of absolute value, we know that $(w - b).re^2 + (w - b).im^2 = b^2 - 2*b*(w.re - b) + (w.re - b)^2 + (w.im)^2$.
  simp [Complex.normSq, Complex.norm_def] at *;
  -- Since $w.re > 0$, we have $(w.re - b)^2 < b^2$.
  have h_re_pos : w.re > 0 := by
    contrapose! hw_ne_zero;
    norm_num [ Complex.ext_iff ] at * ; constructor <;> nlinarith;
  exact Real.sqrt_lt' ( by positivity ) |>.2 ( by norm_num [ Complex.normSq ] ; nlinarith )

lemma abs_Pn_eq_abs_Pn_succ_on_boundary (n : ℕ) (z : ℂ) (hz : z ≠ 0)
    (h_bound : Complex.abs (z^2 - ((n+1 : ℂ))^2) = ((n+1 : ℝ))^2) :
    Complex.abs (P n z) = Complex.abs (P (n+1) z) := by
      -- Using the given condition and the definition of $P$, we can simplify the absolute value ratio.
      have h_abs_ratio : Complex.abs (P (n + 1) z) = Complex.abs (P n z) * (Complex.abs (z^2 - (n + 1)^2) / (n + 1)^2) := by
        -- Apply the lemma abs_P_ratio with k = n.
        apply abs_P_ratio;
      -- Substitute h_bound into h_abs_ratio to simplify the expression.
      rw [h_abs_ratio, h_bound]
      field_simp

lemma increasing_sequence_below_n (n : ℕ) (z : ℂ) (hz : z ≠ 0)
    (h_bound : Complex.abs (z^2 - ((n+1 : ℂ))^2) = ((n+1 : ℝ))^2) :
    ∀ k < n, Complex.abs (P (k+1) z) > Complex.abs (P k z) := by
      -- Apply the increasing_step_of_mem_R lemma with the fact that z is not in the angular region.
      have h_increasing : ∀ k < n, Complex.abs (P (k+1) z) > Complex.abs (P k z) := by
        intro k hk
        have h_lower : Complex.abs (z^2 - (k+1 : ℂ)^2) > (k+1 : ℝ)^2 := by
          have := @boundary_implies_outside_smaller;
          contrapose! this;
          use z^2, (n + 1 : ℝ)^2, (k + 1 : ℝ)^2;
          exact ⟨ pow_ne_zero 2 hz, by positivity, by positivity, by gcongr, mod_cast h_bound, mod_cast this ⟩
        -- Apply the lemma ratio_gt_one_iff with the given h_lower and the fact that P k z is not zero.
        have h_ratio_gt_one : Complex.abs (P (k+1) z) > Complex.abs (P k z) ↔ Complex.abs (z^2 - ((k+1 : ℂ))^2) > ((k+1 : ℝ))^2 := by
          field_simp;
          rw [ abs_P_ratio ];
          rw [ lt_mul_iff_one_lt_right ];
          · rw [ one_lt_div ( by positivity ) ];
          · refine' norm_pos_iff.mpr _;
            refine' P_ne_zero_of_lower_cond _ _ _ _ _ _;
            exacts [ k + 1, hz, fun _ => mod_cast h_lower, by linarith ];
        exact h_ratio_gt_one.mpr h_lower;
      assumption

theorem problem_13_part2_proven (z : ℂ) :
    let angular_region : Set ℂ := {w | w ≠ 0 ∧
        ((Complex.arg w > -π/4 ∧ Complex.arg w < π/4) ∨
         (Complex.arg w > 3*π/4 ∨ Complex.arg w < -3*π/4))}
    z ∉ angular_region → ∀ n : ℕ, Complex.abs (P n z) ≤ Complex.abs (P (n+1) z) := by
      -- Apply the theorem `problem_13_part2_corrected` to conclude the proof.
      apply problem_13_part2_corrected

lemma P_ne_zero_on_boundary (n : ℕ) (z : ℂ) (hz : z ≠ 0)
    (h_bound : Complex.abs (z^2 - ((n+1 : ℂ))^2) = ((n+1 : ℝ))^2) :
    ∀ k, P k z ≠ 0 := by
      -- Since $z \notin L_k$ for any $k$, each factor $(1 - z^2 / k^2)$ is non-zero, implying $P_k(z) \neq 0$.
      intros k
      by_contra h_contra
      obtain ⟨k', hk'⟩ : ∃ k', k' ≤ k ∧ z^2 = (k' : ℂ)^2 := by
        induction' k with k ih generalizing z <;> simp_all +decide [ P ];
        cases' h_contra with h h;
        · exact Exists.elim ( ih z hz h_bound h ) fun k' hk' => ⟨ k', Nat.le_succ_of_le hk'.1, hk'.2 ⟩;
        · exact ⟨ k + 1, by linarith, by rw [ sub_eq_zero, eq_div_iff ( by norm_cast; positivity ) ] at h; norm_num at *; linear_combination' h.symm ⟩;
      rcases k' with ( _ | k' ) <;> simp_all +decide [ sq ];
      -- Since $|k'^2 + 2k' + 1 - n^2 - 2n - 1| = (n + 1)^2$, we have $(k' + 1)^2 - (n + 1)^2 = \pm (n + 1)^2$.
      have h_eq_or_neg : (k' + 1 : ℝ)^2 - (n + 1 : ℝ)^2 = (n + 1 : ℝ)^2 ∨ (k' + 1 : ℝ)^2 - (n + 1 : ℝ)^2 = -(n + 1 : ℝ)^2 := by
        -- Since $|a| = b$ implies $a = b$ or $a = -b$, we can apply this to our hypothesis.
        have h_abs : |((k' + 1 : ℝ)^2 - (n + 1 : ℝ)^2)| = (n + 1 : ℝ)^2 := by
          simp_all +decide [ sq, Complex.normSq, Complex.norm_def ];
          norm_cast at *;
          -- Apply the fact that the absolute value of an integer is the same as its real absolute value.
          have h_abs_int : ∀ (x : ℤ), Complex.abs (x : ℂ) = |x| := by
            norm_num [ Complex.abs, Complex.normSq ];
          exact_mod_cast h_abs_int _ |>.symm.trans h_bound;
        exact eq_or_eq_neg_of_abs_eq h_abs;
      cases' h_eq_or_neg with h h;
      · -- Simplifying $h$, we get $(k' + 1)^2 = 2(n + 1)^2$, which implies $k' + 1 = (n + 1)\sqrt{2}$.
        have h_sqrt : (k' + 1 : ℝ) = (n + 1) * Real.sqrt 2 := by
          rw [ ← sq_eq_sq₀ ] <;> first | positivity | nlinarith [ Real.mul_self_sqrt ( show 0 ≤ 2 by norm_num ) ] ;
        exact irrational_sqrt_two <| ⟨ ( k' + 1 ) / ( n + 1 ), by push_cast [ h_sqrt ] ; rw [ mul_div_cancel_left₀ _ <| by positivity ] ⟩;
      · nlinarith [ show ( k' : ℝ ) ≥ 0 by positivity ]

theorem problem_13_part3_proven (n : ℕ) (z : ℂ) (hz : z ≠ 0) :
    let boundary (k : ℕ) : Set ℂ :=
      {w | Complex.abs (w^2 - ((k+1 : ℂ))^2) = ((k+1 : ℝ))^2}
    z ∈ boundary n →
    Complex.abs (P n z) = Complex.abs (P (n+1) z) ∧
    ∀ m : ℕ, m ≠ n → m ≠ n+1 → Complex.abs (P n z) > Complex.abs (P m z) := by
      intros boundary h_boundary
      have h_increasing : ∀ k < n, Complex.abs (P (k + 1) z) > Complex.abs (P k z) := by
        -- Apply the lemma `increasing_sequence_below_n` with the hypothesis `h_boundary`.
        apply increasing_sequence_below_n n z hz h_boundary
      have h_decreasing : ∀ k > n + 1, Complex.abs (P k z) < Complex.abs (P (k - 1) z) := by
        -- Since $z$ is on the boundary for $n$, we have $|z^2 - (n+1)^2| = (n+1)^2$. For $k > n+1$, we have $|z^2 - k^2| < k^2$.
        have h_decreasing_step : ∀ k > n + 1, Complex.abs (z^2 - (k : ℂ)^2) < (k : ℝ)^2 := by
          intro k hk
          have h_abs : Complex.abs (z^2 - (k : ℂ)^2) = Real.sqrt ((z^2).re^2 + (z^2).im^2 - 2 * (z^2).re * (k : ℝ)^2 + (k : ℝ)^4) := by
            exact congrArg Real.sqrt ( by norm_num [ Complex.normSq, sq ] ; ring );
          have h_abs_lt : (z^2).re^2 + (z^2).im^2 = 2 * (z^2).re * (n + 1 : ℝ)^2 := by
            have := h_boundary;
            -- Squaring both sides of the equation from h_boundary, we get |z^2 - (n+1)^2|^2 = ((n+1)^2)^2.
            have h_sq : (z^2 - (n + 1 : ℂ)^2).re^2 + (z^2 - (n + 1 : ℂ)^2).im^2 = ((n + 1 : ℝ)^2)^2 := by
              -- By definition of absolute value, we know that $|a|^2 = a.re^2 + a.im^2$ for any complex number $a$.
              have h_abs_sq : ∀ a : ℂ, Complex.abs a ^ 2 = a.re ^ 2 + a.im ^ 2 := by
                norm_num [ ← Complex.normSq_add_mul_I, Complex.normSq_eq_norm_sq ];
                exact fun a => rfl;
              rw [ ← h_abs_sq, this ];
            norm_num [ sq ] at * ; linarith;
          rw [ h_abs, Real.sqrt_lt' ];
          · have h_re_pos : (z^2).re > 0 := by
              exact?;
            nlinarith [ show ( k : ℝ ) ^ 2 > ( n + 1 ) ^ 2 by gcongr ; norm_cast ];
          · exact sq_pos_of_pos ( Nat.cast_pos.mpr ( by linarith ) );
        -- Since $|z^2 - k^2| < k^2$ for $k > n+1$, we have $|P_k(z)| < |P_{k-1}(z)|$.
        intros k hk
        have h_ratio : Complex.abs (P k z) = Complex.abs (P (k - 1) z) * (Complex.abs (z^2 - (k : ℂ)^2) / (k : ℝ)^2) := by
          convert abs_P_ratio ( k - 1 ) z using 1 ; rcases k <;> aesop;
          rw [ Nat.cast_sub ( by linarith ) ] ; push_cast ; ring;
          rw [ Nat.cast_sub ( by linarith ) ] ; push_cast ; ring;
        rw [ h_ratio, mul_div ];
        rw [ div_lt_iff₀ ] <;> nlinarith [ h_decreasing_step k hk, show 0 < ( k : ℝ ) ^ 2 by norm_cast; nlinarith, show 0 < Complex.abs ( P ( k - 1 ) z ) from norm_pos_iff.mpr <| show P ( k - 1 ) z ≠ 0 from P_ne_zero_on_boundary n z hz h_boundary ( k - 1 ) ]
      have h_eq : Complex.abs (P n z) = Complex.abs (P (n + 1) z) := by
        exact?
      have h_unique : ∀ m, m ≠ n → m ≠ n + 1 → Complex.abs (P m z) < Complex.abs (P n z) := by
        intro m hm₁ hm₂; cases lt_or_gt_of_ne hm₁ <;> cases lt_or_gt_of_ne hm₂ <;> simp_all +decide ;
        · -- By repeatedly applying the increasing property, we can show that $|P_m(z)| < |P_n(z)|$ for any $m < n$.
          have h_increasing_chain : ∀ k, m < k → k ≤ n → Complex.abs (P m z) < Complex.abs (P k z) := by
            -- By induction on $k$, we can show that $|P_m(z)| < |P_k(z)|$ for any $k$ such that $m < k \leq n$.
            intros k hk₁ hk₂
            induction' hk₁ with k hk ih;
            · exact h_increasing m ‹_›;
            · exact lt_trans ( ih ( Nat.le_of_succ_le hk₂ ) ) ( h_increasing k ( Nat.lt_of_succ_le hk₂ ) );
          linarith [ h_increasing_chain n ( by linarith ) ( by linarith ) ];
        · linarith;
        · omega;
        · -- By induction on $m$, we can show that for any $m > n + 1$, $|P_m(z)| < |P_{n+1}(z)|$.
          induction' m, Nat.succ_le.mpr ‹_› using Nat.le_induction with m ih;
          · exact h_decreasing _ ( Nat.lt_succ_self _ );
          · grind
      exact ⟨h_eq, h_unique⟩