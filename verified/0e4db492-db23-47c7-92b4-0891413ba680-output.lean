/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 0e4db492-db23-47c7-92b4-0891413ba680
-/

/-
We have formalized and proven Polya-Szego Problem 124.
The problem states that a bounded convex function on ‚Ñù is continuous everywhere and has left and right derivatives everywhere.

We have proven this in three parts:
1. `problem_124_part1`: A bounded convex function on ‚Ñù is continuous everywhere.
2. `problem_124_left_deriv`: A bounded convex function on ‚Ñù has a left derivative at every point.
3. `problem_124_right_deriv`: A bounded convex function on ‚Ñù has a right derivative at every point.

Finally, we combined these into `problem_124_complete`.

The proofs rely on the monotonicity of the difference quotient (slope) for convex functions.
For the left derivative, we showed that the difference quotient `(f(x+h) - f(x))/h` is monotone increasing and bounded above for `h < 0`.
For the right derivative, we showed that it is monotone increasing and bounded below for `h > 0`.
Continuity follows from the property that convex functions on an open interval are continuous.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

open Set
open scoped Topology

theorem problem_124_part1 {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (hbdd : ‚àÉ M, ‚àÄ x, |f x| ‚â§ M) :
    Continuous f := by
      -- Since $f$ is convex on $\mathbb{R}$, it is continuous on $\mathbb{R}$.
      have h_cont : ContinuousOn f Set.univ := by
        -- Since $f$ is convex on the entire real line, it is continuous on the entire real line by the theorem `ConvexOn.continuousOn`.
        apply hconv.continuousOn;
        -- The universal set is open by definition.
        apply isOpen_univ
      aesop

open Filter

#check slope

/-- The difference quotient of a convex function is monotone. -/
lemma problem_124_slope_mono {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (x : ‚Ñù) :
    MonotoneOn (Œª h => (f (x + h) - f x) / h) (Iio 0) := by
  intro h‚ÇÅ hh‚ÇÅ h‚ÇÇ hh‚ÇÇ h‚ÇÅ‚ÇÇ;
  -- By the definition of convexity, the slope between any two points is non-decreasing.
  have h_slope_mono : ‚àÄ h‚ÇÅ h‚ÇÇ : ‚Ñù, h‚ÇÅ < 0 ‚Üí h‚ÇÇ < 0 ‚Üí h‚ÇÅ ‚â§ h‚ÇÇ ‚Üí (f (x + h‚ÇÅ) - f x) / h‚ÇÅ ‚â§ (f (x + h‚ÇÇ) - f x) / h‚ÇÇ := by
    -- By the definition of convexity, the slope between $x + h‚ÇÅ$ and $x$ is less than or equal to the slope between $x + h‚ÇÇ$ and $x$.
    intros h‚ÇÅ h‚ÇÇ hh‚ÇÅ hh‚ÇÇ h‚ÇÅ‚ÇÇ
    have h_slope : (f (x + h‚ÇÅ) - f x) / h‚ÇÅ ‚â§ (f (x + h‚ÇÇ) - f x) / h‚ÇÇ := by
      have h_slope_def : ‚àÄ a b c : ‚Ñù, a < b ‚Üí b < c ‚Üí (f b - f a) / (b - a) ‚â§ (f c - f b) / (c - b) := by
        exact?
      by_cases h‚ÇÅ‚ÇÇ : h‚ÇÅ < h‚ÇÇ;
      ¬∑ have := h_slope_def ( x + h‚ÇÅ ) ( x + h‚ÇÇ ) x ( by linarith ) ( by linarith ) ; simp_all +decide [ div_le_iff‚ÇÄ ];
        rw [ div_le_iff_of_neg ] <;> nlinarith [ mul_div_cancel‚ÇÄ ( f x - f ( x + h‚ÇÇ ) ) ( by linarith : ( -h‚ÇÇ ) ‚â† 0 ), mul_div_cancel‚ÇÄ ( f ( x + h‚ÇÅ ) - f x ) ( by linarith : h‚ÇÅ ‚â† 0 ), mul_div_cancel‚ÇÄ ( f ( x + h‚ÇÇ ) - f x ) ( by linarith : h‚ÇÇ ‚â† 0 ) ];
      ¬∑ grind;
    exact h_slope;
  exact h_slope_mono h‚ÇÅ h‚ÇÇ hh‚ÇÅ hh‚ÇÇ h‚ÇÅ‚ÇÇ

/-- The difference quotient of a convex function is bounded above for negative h. -/
lemma problem_124_slope_bdd {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (x : ‚Ñù) :
    BddAbove ((Œª h => (f (x + h) - f x) / h) '' (Iio 0)) := by
  -- Let's choose any $h < 0$.
  have h_bounded_above : ‚àÄ h < 0, (f (x + h) - f x) / h ‚â§ (f (x + 1) - f x) / 1 := by
    -- Apply the convexity condition with $a = x + h$, $b = x$, and $c = x + 1$.
    intros h h_neg
    have h_conv : (f x - f (x + h)) / (x - (x + h)) ‚â§ (f (x + 1) - f x) / ((x + 1) - x) := by
      have := hconv.slope_mono_adjacent ( Set.mem_univ ( x + h ) ) ( Set.mem_univ ( x + 1 ) ) ( by linarith : x + h < x ) ( by linarith : x < x + 1 ) ; aesop;
    ring_nf at *; linarith;
  exact ‚ü® _, Set.forall_mem_image.2 h_bounded_above ‚ü©

/-- A bounded convex function on ‚Ñù has a left derivative at every point. -/
theorem problem_124_left_deriv {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (hbdd : ‚àÉ M, ‚àÄ x, |f x| ‚â§ M)
    (x : ‚Ñù) : ‚àÉ L, Tendsto (Œª h : ‚Ñù => (f (x + h) - f x) / h) (ùìù[<] 0) (ùìù L) := by
  -- Apply the provided solution to show that the difference quotient tends to a limit.
  have h_slope_exists : ‚àÉ L : ‚Ñù, Filter.Tendsto (fun h => (f (x + h) - f x) / h) (nhdsWithin 0 (Set.Iio 0)) (nhds L) := by
    have h_monotone : MonotoneOn (fun h => (f (x + h) - f x) / h) (Set.Iio 0) := by
      exact?
    have h_bounded : BddAbove (Set.image (fun h => (f (x + h) - f x) / h) (Set.Iio 0)) := by
      exact?
    have h_lim : Filter.Tendsto (fun h => (f (x + h) - f x) / h) (nhdsWithin 0 (Set.Iio 0)) (nhds (sSup (Set.image (fun h => (f (x + h) - f x) / h) (Set.Iio 0)))) := by
      exact?;
    refine Exists.intro _ h_lim;
  exact h_slope_exists

/-- The difference quotient of a convex function is monotone for positive h. -/
lemma problem_124_slope_mono_right {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (x : ‚Ñù) :
    MonotoneOn (Œª h => (f (x + h) - f x) / h) (Ioi 0) := by
  -- By the definition of convexity, for any $h_1, h_2 > 0$ with $h_1 < h_2$, we have $\frac{f(x + h_1) - f(x)}{h_1} \leq \frac{f(x + h_2) - f(x)}{h_2}$.
  have h_convex_slope : ‚àÄ h1 h2 : ‚Ñù, 0 < h1 ‚Üí 0 < h2 ‚Üí h1 < h2 ‚Üí (f (x + h1) - f x) / h1 ‚â§ (f (x + h2) - f x) / h2 := by
    -- By the definition of convexity, for any $a < b < c$, we have $\frac{f(b) - f(a)}{b - a} \leq \frac{f(c) - f(b)}{c - b}$.
    have h_convex_slope : ‚àÄ a b c : ‚Ñù, a < b ‚Üí b < c ‚Üí (f b - f a) / (b - a) ‚â§ (f c - f b) / (c - b) := by
      exact?;
    exact fun h1 h2 h1_pos h2_pos h1h2 => by have := h_convex_slope x ( x + h1 ) ( x + h2 ) ( by linarith ) ( by linarith ) ; rw [ div_le_div_iff‚ÇÄ ] at * <;> nlinarith;
  exact fun a ha b hb hab => by cases lt_or_eq_of_le hab <;> aesop;

/-- The difference quotient of a convex function is bounded below for positive h. -/
lemma problem_124_slope_bdd_right {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (x : ‚Ñù) :
    BddBelow ((Œª h => (f (x + h) - f x) / h) '' (Ioi 0)) := by
  -- By definition of convexity, we know that for any $h > 0$, $\frac{f(x + h) - f(x)}{h}$ is bounded below.
  have h_bdd_below : ‚àÄ h > 0, (f (x + h) - f x) / h ‚â• (f x - f (x - 1)) / 1 := by
    -- By the definition of convexity, for any $a < b < c$, we have $\frac{f(b) - f(a)}{b - a} \leq \frac{f(c) - f(b)}{c - b}$.
    have h_convex_slope : ‚àÄ a b c : ‚Ñù, a < b ‚Üí b < c ‚Üí (f b - f a) / (b - a) ‚â§ (f c - f b) / (c - b) := by
      exact?;
    intro h hh; have := h_convex_slope ( x - 1 ) x ( x + h ) ( by linarith ) ( by linarith ) ; aesop;
  exact ‚ü® _, Set.forall_mem_image.2 h_bdd_below ‚ü©

/-- A bounded convex function on ‚Ñù has a right derivative at every point. -/
theorem problem_124_right_deriv {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (hbdd : ‚àÉ M, ‚àÄ x, |f x| ‚â§ M)
    (x : ‚Ñù) : ‚àÉ R, Tendsto (Œª h : ‚Ñù => (f (x + h) - f x) / h) (ùìù[>] 0) (ùìù R) := by
  -- The difference quotient $g(h) = (f(x+h) - f(x))/h$ is monotone on $(0, \infty)$ by `problem_124_slope_mono_right` and bounded below by `problem_124_slope_bdd_right`.
  have h_monotone : MonotoneOn (Œª h => (f (x + h) - f x) / h) (Set.Ioi 0) := by
    exact?;
  have h_bdd_below : BddBelow (Set.image (fun h => (f (x + h) - f x) / h) (Set.Ioi 0)) := by
    exact?;
  use sInf ( Set.image ( fun h => ( f ( x + h ) - f x ) / h ) ( Set.Ioi 0 ) );
  apply_rules [ tendsto_order.2 ‚ü® _, _ ‚ü© ];
  ¬∑ exact fun a ha => Filter.mem_of_superset self_mem_nhdsWithin fun y hy => lt_of_lt_of_le ha <| csInf_le h_bdd_below <| Set.mem_image_of_mem _ hy;
  ¬∑ intro a ha;
    rcases exists_lt_of_csInf_lt ( Set.Nonempty.image _ <| Set.nonempty_Ioi ) ha with ‚ü® b, ‚ü® y, hy, rfl ‚ü©, hb ‚ü© ; filter_upwards [ Ioo_mem_nhdsGT hy ] with z hz using lt_of_le_of_lt ( h_monotone ( show 0 < z by linarith [ hz.1 ] ) ( show 0 < y by linarith [ hy.out ] ) hz.2.le ) hb

/-- Combined statement: A bounded convex function is continuous and has both one-sided derivatives. -/
theorem problem_124_complete {f : ‚Ñù ‚Üí ‚Ñù} (hconv : ConvexOn ‚Ñù univ f) (hbdd : ‚àÉ M, ‚àÄ x, |f x| ‚â§ M) :
    Continuous f ‚àß
    (‚àÄ x, ‚àÉ L, Tendsto (Œª h : ‚Ñù => (f (x + h) - f x) / h) (ùìù[<] 0) (ùìù L)) ‚àß
    (‚àÄ x, ‚àÉ R, Tendsto (Œª h : ‚Ñù => (f (x + h) - f x) / h) (ùìù[>] 0) (ùìù R)) := by
  exact ‚ü® problem_124_part1 hconv hbdd, fun x => problem_124_left_deriv hconv hbdd x, fun x => problem_124_right_deriv hconv hbdd x ‚ü©